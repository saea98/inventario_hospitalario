{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load custom_filters %}

{% block title %}Editar Lote - Sistema de Inventario{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit"></i> Editar Lote
                </h5>
            </div>
            <div class="card-body">
                <!-- DEBUG INFO -->
            <!---
                <div class="alert alert-info">
                    <h6>üîç Informaci√≥n de Debug:</h6>
                    <p>Almac√©n en instancia: {{ form.instance.almacen }}</p>
                    <p>Ubicaci√≥n en instancia: {{ form.instance.ubicacion }}</p>
                    <p>Campos en formulario: 
                        {% for field in form %}
                            {{ field.name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </p>
                </div>
            -->
                <form method="post" novalidate id="lote-form">
                    {% csrf_token %}
                    
                    <!-- Renderizar campos manualmente para debug -->
                    <div class="mb-3">
                        <label for="id_almacen" class="form-label">Almac√©n *</label>
                        {{ form.almacen }}
                        {% if form.almacen.errors %}
                            <div class="text-danger">{{ form.almacen.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_ubicacion" class="form-label">Ubicaci√≥n</label>
                        {{ form.ubicacion }}
                        {% if form.ubicacion.errors %}
                            <div class="text-danger">{{ form.ubicacion.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Resto de campos con crispy -->
                    {% for field in form %}
                        {% if field.name != 'almacen' and field.name != 'ubicacion' %}
                            <div class="form-group">
                                {{ field|as_crispy_field }}
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                    <div class="d-flex justify-content-between mt-3">
                        <a href="{% url 'lista_lotes' %}" class="btn btn-secondary me-2">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Actualizar Lote
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {
    console.log("=== INICIO DEBUG FORMULARIO LOTE ===");
    
    // Verificar elementos
    console.log("üìç Campo almac√©n encontrado:", $('#id_almacen').length);
    console.log("üìç Campo ubicaci√≥n encontrado:", $('#id_ubicacion').length);
    console.log("üìç Valor inicial almac√©n:", $('#id_almacen').val());
    console.log("üìç Valor inicial ubicaci√≥n:", $('#id_ubicacion').val());
    
    // Verificar jQuery y Select2
    console.log("üìö jQuery version:", $.fn.jquery);
    console.log("üìö Select2 version:", $.fn.select2 ? $.fn.select2.version : "NO CARGADO");
    
    // Inicializar Select2
    if ($.fn.select2) {
        $('select').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: 'Seleccione una opci√≥n',
            allowClear: true
        });
        console.log("‚úÖ Select2 inicializado");
    } else {
        console.error("‚ùå Select2 no est√° cargado");
    }

    // Funci√≥n mejorada para cargar ubicaciones
    function cargarUbicaciones(almacenId) {
        console.log("üîç Cargando ubicaciones para almac√©n:", almacenId);
        
        if (!almacenId) {
            $('#id_ubicacion').empty().append('<option value="">---------</option>');
            $('#id_ubicacion').trigger('change');
            console.log("‚ö†Ô∏è No hay almac√©n seleccionado");
            return;
        }

        $.ajax({
            url: "{% url 'ajax_ubicaciones_por_almacen' %}",
            data: { 'almacen': almacenId },
            method: 'GET',
            success: function (data) {
                console.log("‚úÖ Respuesta AJAX recibida:", data);
                
                var $ubicacionSelect = $('#id_ubicacion');
                var valorActual = $ubicacionSelect.val();
                
                $ubicacionSelect.empty();
                $ubicacionSelect.append('<option value="">---------</option>');
                
                if (data && data.length > 0) {
                    $.each(data, function(index, ubicacion) {
                        $ubicacionSelect.append(
                            $('<option>', {
                                value: ubicacion.id,
                                text: ubicacion.codigo + (ubicacion.descripcion ? ' - ' + ubicacion.descripcion : '')
                            })
                        );
                    });
                    console.log("üìç " + data.length + " ubicaciones cargadas");
                } else {
                    console.warn("‚ö†Ô∏è No se encontraron ubicaciones para este almac√©n");
                }
                
                // Restaurar valor anterior si existe
                if (valorActual) {
                    $ubicacionSelect.val(valorActual);
                }
                
                $ubicacionSelect.trigger('change');
            },
            error: function(xhr, status, error) {
                console.error("‚ùå Error en AJAX:", error);
                console.log("üìÑ Respuesta:", xhr.responseText);
            }
        });
    }

    // Evento change para almac√©n
    $('#id_almacen').on('change', function() {
        console.log("üîÑ Almac√©n cambiado a:", $(this).val());
        cargarUbicaciones($(this).val());
    });

    // Cargar ubicaciones al iniciar si hay almac√©n
    var almacenInicial = $('#id_almacen').val();
    if (almacenInicial) {
        console.log("üîÑ Cargando ubicaciones iniciales...");
        cargarUbicaciones(almacenInicial);
    }

    console.log("=== FIN DEBUG FORMULARIO LOTE ===");
});
</script>
<script>
// Script para asegurar formato de fechas
$(document).ready(function() {
    // Verificar que las fechas est√©n en formato YYYY-MM-DD
    $('input[type="date"]').each(function() {
        var currentValue = $(this).val();
        if (currentValue) {
            // Si la fecha est√° en formato DD/MM/YYYY, convertirla
            if (currentValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                var parts = currentValue.split('/');
                var newValue = parts[2] + '-' + parts[1] + '-' + parts[0];
                $(this).val(newValue);
            }
        }
    });
});
</script>
{% endblock %}