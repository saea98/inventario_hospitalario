{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
<style>
    .datos-llegada-section {
        background-color: #e8f4f8;
        padding: 15px;
        border-left: 4px solid #0066cc;
        margin-bottom: 20px;
    }
    
    .table-items {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .table-items th {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        text-align: left;
        font-weight: bold;
        font-size: 0.85rem;
    }
    
    .table-items td {
        border: 1px solid #dee2e6;
        padding: 6px;
    }
    
    .table-items input,
    .table-items select {
        width: 100%;
        padding: 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 0.85rem;
    }
    
    .table-items .select2-container {
        width: 100% !important;
    }
    
    .row-principal {
        background-color: #ffffff;
    }
    
    .row-precios {
        background-color: #f9f9f9;
    }
    
    .btn-remove-item {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 4px 8px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 0.85rem;
    }
    
    .btn-remove-item:hover {
        background-color: #c82333;
    }
    
    .validation-error {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }
    
    .campo-calculado {
        background-color: #f0f0f0;
        font-weight: bold;
    }
    
    .campo-editable {
        background-color: #ffffff;
    }
    
    .folio-display {
        background-color: #e8f4f8;
        padding: 8px;
        border-radius: 3px;
        font-weight: bold;
        color: #0066cc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-2 text-gray-800">Registrar Nueva Llegada de Proveedor</h1>
    <p class="mb-4">Completa los datos para registrar una nueva llegada. Los campos verdes son de captura obligatoria.</p>

    <form method="post" id="llegada-form">
        {% csrf_token %}
        
        <!-- Datos de Llegada -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">游늶 Datos de la Llegada</h6>
            </div>
            <div class="card-body">
                <div class="datos-llegada-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_cita"><strong>Cita Autorizada *</strong></label>
                                {{ form.cita }}
                                {% if form.cita.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.cita.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Folio de Llegada</strong></label>
                                <div class="folio-display" id="folio-display">Se genera autom치ticamente</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_remision"><strong>Remisi칩n *</strong></label>
                                {{ form.remision }}
                                {% if form.remision.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.remision.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_almacen"><strong>Almac칠n *</strong></label>
                                {{ form.almacen }}
                                {% if form.almacen.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.almacen.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="id_numero_piezas_emitidas"><strong>Piezas Emitidas *</strong></label>
                                {{ form.numero_piezas_emitidas }}
                                {% if form.numero_piezas_emitidas.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.numero_piezas_emitidas.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="id_numero_piezas_recibidas"><strong>Piezas Recibidas *</strong></label>
                                {{ form.numero_piezas_recibidas }}
                                {% if form.numero_piezas_recibidas.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.numero_piezas_recibidas.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="id_tipo_red"><strong>Tipo de Red</strong></label>
                                {{ form.tipo_red }}
                                {% if form.tipo_red.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.tipo_red.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Orden de Suministro (Referencia)</strong></label>
                                <div class="form-control" id="orden-suministro-ref" style="background-color: #f8f9fa; color: #666; padding: 8px;">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Clave de Producto (Referencia)</strong></label>
                                <div class="form-control" id="clave-producto-ref" style="background-color: #f8f9fa; color: #666; padding: 8px;">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_observaciones_recepcion"><strong>Observaciones</strong></label>
                        {{ form.observaciones_recepcion }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Items de Llegada -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">游닍 Items de la Llegada (Captura R치pida)</h6>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                
                <div class="table-responsive">
                    <table class="table-items">
                        <thead style="display: none;"></thead>
                        <tbody id="items-tbody">
                            {% for form in formset %}
                                <!-- FILA 1: Datos del Lote y Cantidades -->
                                <tr class="item-row row-principal" data-form-index="{{ forloop.counter0 }}">
                                    <td><small class="text-muted d-block mb-1">Producto</small>{{ form.producto }}</td>
                                    <td><small class="text-muted d-block mb-1">Lote</small>{{ form.numero_lote }}</td>
                                    <td><small class="text-muted d-block mb-1">Marca</small>{{ form.marca }}</td>
                                    <td><small class="text-muted d-block mb-1">Fabricante</small>{{ form.fabricante }}</td>
                                    <td><small class="text-muted d-block mb-1">F. Elab.</small>{{ form.fecha_elaboracion }}</td>
                                    <td><small class="text-muted d-block mb-1">F. Caduc.</small>{{ form.fecha_caducidad }}</td>
                                    <td style="display: none;"><small class="text-muted d-block mb-1">Emitida</small>{{ form.cantidad_emitida }}</td>
                                    <td><small class="text-muted d-block mb-1">Recibida</small>{{ form.cantidad_recibida }}</td>
                                    <td style="display: none;"><small class="text-muted d-block mb-1">Piezas/Lote</small>{{ form.piezas_por_lote }}</td>
                                    <td>
                                        {% if not forloop.first %}
                                            <button type="button" class="btn-remove-item" onclick="removeRow(this)">Eliminar</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                
                                <!-- FILA 2: Precios e IVA -->
                                <tr class="item-row row-precios" data-form-index="{{ forloop.counter0 }}">
                                    <td><small class="text-muted d-block mb-1">P. Unitario</small><input type="number" id="{{ form.precio_unitario_sin_iva.id_for_label }}" name="{{ form.precio_unitario_sin_iva.html_name }}" class="form-control precio-unitario" step="0.01" placeholder="0.00" value="{{ form.precio_unitario_sin_iva.value|default:'' }}"></td>
                                    <td><small class="text-muted d-block mb-1">% IVA</small><input type="number" id="{{ form.porcentaje_iva.id_for_label }}" name="{{ form.porcentaje_iva.html_name }}" class="form-control porcentaje-iva" step="0.01" placeholder="0.00" value="{{ form.porcentaje_iva.value|default:'' }}" readonly></td>
                                    <td><small class="text-muted d-block mb-1">P. c/IVA</small><input type="number" id="{{ form.precio_unitario_con_iva.id_for_label }}" name="{{ form.precio_unitario_con_iva.html_name }}" class="form-control precio-con-iva" step="0.01" placeholder="0.00" value="{{ form.precio_unitario_con_iva.value|default:'' }}" readonly></td>
                                    <td><small class="text-muted d-block mb-1">Subtotal</small><input type="number" id="{{ form.subtotal.id_for_label }}" name="{{ form.subtotal.html_name }}" class="form-control subtotal" step="0.01" placeholder="0.00" value="{{ form.subtotal.value|default:'' }}" readonly></td>
                                    <td><small class="text-muted d-block mb-1">Importe IVA</small><input type="number" id="{{ form.importe_iva.id_for_label }}" name="{{ form.importe_iva.html_name }}" class="form-control importe-iva" step="0.01" placeholder="0.00" value="{{ form.importe_iva.value|default:'' }}" readonly></td>
                                    <td><small class="text-muted d-block mb-1">Total</small><input type="number" id="{{ form.importe_total.id_for_label }}" name="{{ form.importe_total.html_name }}" class="form-control importe-total" step="0.01" placeholder="0.00" value="{{ form.importe_total.value|default:'' }}" readonly></td>
                                    <td colspan="2"></td>
                                </tr>
                                
                                {% if form.non_field_errors %}
                                    <tr>
                                        <td colspan="12" class="alert alert-danger">
                                            {{ form.non_field_errors }}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <button type="button" id="add-item-btn" class="btn btn-success btn-sm mt-3">+ Agregar Lote</button>
                <div id="validation-message" class="alert alert-warning mt-3" style="display: none;"></div>
            </div>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary btn-lg">游 Guardar Llegada</button>
            <a href="{% url 'logistica:llegadas:lista_llegadas' %}" class="btn btn-secondary btn-lg">Cancelar</a>
        </div>
    </form>
</div>

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Inicializar Select2
    $('#id_cita').select2({
        dropdownParent: $('body'),
        width: '100%'
    });
    
    $('#id_almacen').select2({
        dropdownParent: $('body'),
        width: '100%'
    });
    
    initializeProductSelect2();
    
    // Agregar nueva fila
    $('#add-item-btn').click(function(e) {
        e.preventDefault();
        addItemRow();
    });
    
    // Validar al enviar
    $('#llegada-form').on('submit', function(e) {
        if (!validatePiezasSum()) {
            e.preventDefault();
            showValidationMessage('La suma de piezas por lote debe ser igual a la cantidad recibida en cada item.');
        }
    });
    
    // Cargar datos de cita cuando se selecciona
    $('#id_cita').on('change', function() {
        var citaId = $(this).val();
        if (citaId) {
            $.ajax({
                url: '/logistica/llegadas/api/cita/' + citaId + '/folio/',
                type: 'GET',
                success: function(data) {
                    $('#folio-display').text(data.folio || 'Se genera autom치ticamente');
                    if (data.remision) $('#id_remision').val(data.remision);
                    if (data.orden_suministro) {
                        $('#id_numero_orden_suministro').val(data.orden_suministro);
                        $('#orden-suministro-ref').text(data.orden_suministro);
                    }
                    if (data.contrato) $('#id_numero_contrato').val(data.contrato);
                    if (data.almacen_id) $('#id_almacen').val(data.almacen_id).trigger('change');
                    if (data.clave_medicamento) {
                        $('#clave-producto-ref').text(data.clave_medicamento);
                        window.citaClaveDefault = data.clave_medicamento;
                        // Pre-seleccionar producto con esta clave en todos los selects
                        $('select[id$="-producto"]').each(function() {
                            var $select = $(this);
                            var $option = $select.find('option').filter(function() {
                                return $(this).text().includes(data.clave_medicamento);
                            }).first();
                            if ($option.length) {
                                $select.val($option.val()).trigger('change');
                            }
                        });
                    }
                },
                error: function() {
                    console.log('Error al cargar datos de cita');
                }
            });
        }
    });
});

function initializeProductSelect2() {
    $('select[id$="-producto"]').each(function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).select2({
                dropdownParent: $('body'),
                width: '100%',
                placeholder: 'Selecciona un producto...'
            });
        }
        $(this).on('select2:select', function() {
            calcularIVADelProducto($(this));
        });
        $(this).on('change', function() {
            calcularIVADelProducto($(this));
        });
    });
}

function calcularIVADelProducto($selectProducto) {
    var selectedText = $selectProducto.find('option:selected').text();

    var clave = extraerClaveDelProducto(selectedText);

    var filaActual = $selectProducto.closest('tr');
    var formIndex = filaActual.data('form-index');

    var $ivaInput = $('input[name="items-' + formIndex + '-porcentaje_iva"]');

    
    if (clave && (clave.startsWith('060') || clave.startsWith('080') || clave.startsWith('130') || clave.startsWith('379'))) {
        $ivaInput.val('0.16');
    } else {
        $ivaInput.val('0.00');
    }
    
    // Agregar eventos para calcular precios
    var $precioUnitario = $('input[name="items-' + formIndex + '-precio_unitario_sin_iva"]');
    $precioUnitario.off('change').on('change', function() {
        calcularPreciosDelItem(formIndex);
    });
    
    var $cantidadRecibida = $('input[name="items-' + formIndex + '-cantidad_recibida"]');
    $cantidadRecibida.off('change').on('change', function() {
        calcularPreciosDelItem(formIndex);
    });
}

function extraerClaveDelProducto(texto) {
    // Extrae los primeros 3 d칤gitos de la clave (formato: "Producto - 060.830.7070" o similar)
    var match = texto.match(/(\d{3})/);
    return match ? match[1] : null;
}

function addItemRow() {
    var formCount = $('#id_items-TOTAL_FORMS').val();
    var newFormIndex = parseInt(formCount);
    
    // FILA 1: Datos del Lote
    var newRow1 = $('<tr class="item-row row-principal" data-form-index="' + newFormIndex + '">' +
        '<td><select id="id_items-' + newFormIndex + '-producto" name="items-' + newFormIndex + '-producto" class="form-control"></select></td>' +
        '<td><input type="text" id="id_items-' + newFormIndex + '-clave" name="items-' + newFormIndex + '-clave" class="form-control clave-cnis" placeholder="CNIS"></td>' +
        '<td><input type="text" id="id_items-' + newFormIndex + '-numero_lote" name="items-' + newFormIndex + '-numero_lote" class="form-control numero-lote"></td>' +
        '<td><input type="text" id="id_items-' + newFormIndex + '-marca" name="items-' + newFormIndex + '-marca" class="form-control"></td>' +
        '<td><input type="text" id="id_items-' + newFormIndex + '-fabricante" name="items-' + newFormIndex + '-fabricante" class="form-control"></td>' +
        '<td><input type="date" id="id_items-' + newFormIndex + '-fecha_elaboracion" name="items-' + newFormIndex + '-fecha_elaboracion" class="form-control"></td>' +
        '<td><input type="date" id="id_items-' + newFormIndex + '-fecha_caducidad" name="items-' + newFormIndex + '-fecha_caducidad" class="form-control"></td>' +
        '<td><button type="button" class="btn-remove-item" onclick="removeRow(this)">Eliminar</button></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-cantidad_emitida" name="items-' + newFormIndex + '-cantidad_emitida" class="form-control cantidad-emitida"></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-cantidad_recibida" name="items-' + newFormIndex + '-cantidad_recibida" class="form-control cantidad-recibida"></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-piezas_por_lote" name="items-' + newFormIndex + '-piezas_por_lote" class="form-control piezas-por-lote" min="1" value="1"></td>' +
        '<td></td>' +
        '</tr>');
    
    // FILA 2: Precios e IVA
    var newRow2 = $('<tr class="item-row row-precios" data-form-index="' + newFormIndex + '">' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-precio_unitario_sin_iva" name="items-' + newFormIndex + '-precio_unitario_sin_iva" class="form-control precio-unitario" step="0.01" placeholder="0.00"></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-porcentaje_iva" name="items-' + newFormIndex + '-porcentaje_iva" class="form-control porcentaje-iva" step="0.01" placeholder="0.00" readonly></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-precio_unitario_con_iva" name="items-' + newFormIndex + '-precio_unitario_con_iva" class="form-control precio-con-iva" step="0.01" placeholder="0.00" readonly></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-subtotal" name="items-' + newFormIndex + '-subtotal" class="form-control subtotal" step="0.01" placeholder="0.00" readonly></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-importe_iva" name="items-' + newFormIndex + '-importe_iva" class="form-control importe-iva" step="0.01" placeholder="0.00" readonly></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-importe_total" name="items-' + newFormIndex + '-importe_total" class="form-control importe-total" step="0.01" placeholder="0.00" readonly></td>' +
        '<td colspan="2"></td>' +
        '</tr>');
    
    $('#items-tbody').append(newRow1);
    $('#items-tbody').append(newRow2);
    
    $('#id_items-TOTAL_FORMS').val(newFormIndex + 1);
    
    // Inicializar Select2 para el nuevo producto
    var newSelect = newRow1.find('select[id$="-producto"]');
    newSelect.select2({
        dropdownParent: $('body'),
        width: '100%',
        placeholder: 'Selecciona un producto...'
    });
    
    // Agregar eventos para calcular IVA
    newSelect.on('select2:select', function() {
        calcularIVADelProducto($(this));
    });
    newSelect.on('change', function() {
        calcularIVADelProducto($(this));
    });
    
    // Cargar opciones de productos
    $.ajax({
        url: '/logistica/llegadas/api/productos/',
        type: 'GET',
        success: function(data) {
            $.each(data, function(index, producto) {
                newSelect.append('<option value="' + producto.id + '">' + producto.descripcion + '</option>');
            });
        }
    });
    
    // Agregar validaciones
    addFieldValidation(newRow1, newRow2);
}

function removeRow(btn) {
    var row = $(btn).closest('tr');
    var formIndex = row.data('form-index');
    
    // Eliminar ambas filas (principal y precios)
    $('#items-tbody tr[data-form-index="' + formIndex + '"]').remove();
    updateFormCount();
}

function updateFormCount() {
    var count = $('#items-tbody tr.row-principal').length;
    $('#id_items-TOTAL_FORMS').val(count);
}

function addFieldValidation(row1, row2) {
    var formIndex = row1.data('form-index');
    var row2Actual = $('tr.row-precios[data-form-index="' + formIndex + '"]');
    alert('addFieldValidation ejecutado para formIndex: ' + formIndex);
    alert('row2Actual encontrado: ' + row2Actual.length);
    // Validar cantidad_recibida <= cantidad_emitida
    row1.find('.cantidad-recibida').on('change', function() {
        var cantEmitida = row1.find('input[name$="-cantidad_emitida"]').val();
        var cantRecibida = $(this).val();
        if (parseInt(cantRecibida) > parseInt(cantEmitida)) {
            $(this).css('border-color', 'red');
        } else {
            $(this).css('border-color', '');
        }
    });
    
    // Calcular IVA autom치tico seg칰n clave
    row1.find('.clave-cnis').on('change', function() {
        var clave = $(this).val();
        var ivaField = row2.find('.porcentaje-iva');
        
        if (clave.startsWith('060') || clave.startsWith('080') || clave.startsWith('130') || clave.startsWith('379')) {
            ivaField.val('16.00');
        } else {
            ivaField.val('0.00');
        }
        
        calculatePrices(row1, row2);
    });
    
    // Calcular precios cuando cambia precio unitario
    row2Actual.find('.precio-unitario').on('change', function() {
        alert('Evento change en precio_unitario: ' + $(this).val());
        calculatePrices(row1, row2Actual);
    });
    
    // Calcular precios cuando cambia cantidad recibida (agregar alert)
    row1.find('.cantidad-recibida').on('change', function() {
        alert('Evento change en cantidad_recibida: ' + $(this).val());
        calculatePrices(row1, row2Actual);
    });
}

function calculatePrices(row1, row2) {
    var precioUnitario = parseFloat(row2.find('.precio-unitario').val()) || 0;
    var porcentajeIva = parseFloat(row2.find('.porcentaje-iva').val()) || 0;
    var cantRecibida = parseInt(row1.find('.cantidad-recibida').val()) || 0;
    
    // Calcular precio con IVA (porcentajeIva ya est치 en formato 0.16 o 0.00)
    var precioConIva = precioUnitario * (1 + porcentajeIva);
    
    // Calcular subtotal (precio unitario * cantidad)
    var subtotal = precioUnitario * cantRecibida;
    
    // Calcular importe IVA (porcentajeIva ya est치 en formato 0.16 o 0.00)
    var importeIva = subtotal * porcentajeIva;
    
    // Calcular importe total
    var importeTotal = subtotal + importeIva;
    
    row2.find('.precio-con-iva').val(precioConIva.toFixed(2));
    row2.find('.subtotal').val(subtotal.toFixed(2));
    row2.find('.importe-iva').val(importeIva.toFixed(2));
    row2.find('.importe-total').val(importeTotal.toFixed(2));
}

function validatePiezasSum() {
    var isValid = true;
    var errorMessages = [];
    
    $('#items-tbody tr.row-principal').each(function() {
        var cantRecibida = parseInt($(this).find('input[name$="-cantidad_recibida"]').val()) || 0;
        var piezasLote = parseInt($(this).find('input[name$="-piezas_por_lote"]').val()) || 0;
        
        if (cantRecibida > 0 && piezasLote !== cantRecibida) {
            $(this).find('input[name$="-piezas_por_lote"]').css('border-color', 'red');
            errorMessages.push('Lote: La suma de piezas por lote debe ser igual a la cantidad recibida');
            isValid = false;
        } else {
            $(this).find('input[name$="-piezas_por_lote"]').css('border-color', '');
        }
    });
    
    if (!isValid) {
        showValidationMessage(errorMessages.join('<br>'));
    }
    
    return isValid;
}

function showValidationMessage(message) {
    var msgDiv = $('#validation-message');
    msgDiv.html(message);
    msgDiv.show();
    $('html, body').animate({scrollTop: msgDiv.offset().top - 100}, 'slow');
}
</script>
{% endblock %}
{% endblock %}

