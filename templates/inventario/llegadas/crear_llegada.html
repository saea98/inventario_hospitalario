{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
<style>
    .table-items {
        width: 100%;
        border-collapse: collapse;
    }
    .table-items th {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        text-align: left;
        font-weight: bold;
    }
    .table-items td {
        border: 1px solid #dee2e6;
        padding: 8px;
    }
    .table-items input,
    .table-items select {
        width: 100%;
        padding: 5px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }
    .table-items .select2-container {
        width: 100% !important;
    }
    .btn-remove-item {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
    }
    .btn-remove-item:hover {
        background-color: #c82333;
    }
    .validation-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-2 text-gray-800">Registrar Nueva Llegada</h1>
    <p class="mb-4">Completa los datos para registrar una nueva llegada de proveedor.</p>

    <form method="post" id="llegada-form">
        {% csrf_token %}
        
        <!-- Datos principales -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Datos de la Llegada</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_cita">Cita Autorizada *</label>
                            {{ form.cita }}
                            {% if form.cita.errors %}
                                <div class="alert alert-danger mt-2">{{ form.cita.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_remision">Remisión *</label>
                            {{ form.remision }}
                            {% if form.remision.errors %}
                                <div class="alert alert-danger mt-2">{{ form.remision.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_numero_piezas_emitidas">Número de Piezas Emitidas *</label>
                            {{ form.numero_piezas_emitidas }}
                            {% if form.numero_piezas_emitidas.errors %}
                                <div class="alert alert-danger mt-2">{{ form.numero_piezas_emitidas.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_numero_piezas_recibidas">Número de Piezas Recibidas *</label>
                            {{ form.numero_piezas_recibidas }}
                            {% if form.numero_piezas_recibidas.errors %}
                                <div class="alert alert-danger mt-2">{{ form.numero_piezas_recibidas.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_almacen">Almacén *</label>
                            {{ form.almacen }}
                            {% if form.almacen.errors %}
                                <div class="alert alert-danger mt-2">{{ form.almacen.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="id_tipo_red">Tipo de Red</label>
                            {{ form.tipo_red }}
                            {% if form.tipo_red.errors %}
                                <div class="alert alert-danger mt-2">{{ form.tipo_red.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="id_observaciones_recepcion">Observaciones</label>
                    {{ form.observaciones_recepcion }}
                </div>
            </div>
        </div>

        <!-- Items en formato tabla (tipo Excel) -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Items de la Llegada (Captura Rápida)</h6>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                
                <div class="table-responsive">
                    <table class="table-items">
                        <thead>
                            <tr>
                                <th style="width: 18%;">Producto (CNIS)</th>
                                <th style="width: 12%;">Lote</th>
                                <th style="width: 10%;">Caducidad</th>
                                <th style="width: 8%;">Cant. Emitida</th>
                                <th style="width: 8%;">Cant. Recibida</th>
                                <th style="width: 8%;">Piezas/Lote</th>
                                <th style="width: 12%;">Marca</th>
                                <th style="width: 8%;">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="items-tbody">
                            {% for form in formset %}
                                <tr class="item-row" data-form-index="{{ forloop.counter0 }}">
                                    <td>{{ form.producto }}</td>
                                    <td>{{ form.numero_lote }}</td>
                                    <td>{{ form.fecha_caducidad }}</td>
                                    <td>{{ form.cantidad_emitida }}</td>
                                    <td>{{ form.cantidad_recibida }}</td>
                                    <td>{{ form.piezas_por_lote }}</td>
                                    <td>{{ form.marca }}</td>
                                    <td>
                                        {% if not forloop.first %}
                                            <button type="button" class="btn-remove-item" onclick="removeRow(this)">Eliminar</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if form.non_field_errors %}
                                    <tr>
                                        <td colspan="8" class="alert alert-danger">
                                            {{ form.non_field_errors }}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <button type="button" id="add-item-btn" class="btn btn-success btn-sm mt-3">+ Agregar Fila</button>
            </div>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary">Guardar Llegada</button>
            <a href="{% url 'logistica:llegadas:lista_llegadas' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Inicializar Select2 para el campo de cita
    $('#id_cita').select2({
        dropdownParent: $('body'),
        width: '100%'
    });
    
    // Inicializar Select2 para el campo de almacen
    $('#id_almacen').select2({
        dropdownParent: $('body'),
        width: '100%'
    });
    
    // Inicializar Select2 para todos los campos de producto
    initializeProductSelect2();
    
    // Agregar nueva fila
    $('#add-item-btn').click(function(e) {
        e.preventDefault();
        addItemRow();
    });
    
    // Validar suma de piezas_por_lote al enviar
    $('#llegada-form').on('submit', function(e) {
        if (!validatePiezasSum()) {
            e.preventDefault();
            alert('La suma de piezas por lote debe ser igual a la cantidad recibida en cada item.');
        }
    });
});

function initializeProductSelect2() {
    $('select[id$="-producto"]').each(function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).select2({
                dropdownParent: $('body'),
                width: '100%',
                placeholder: 'Selecciona un producto...'
            });
        }
    });
}

function addItemRow() {
    var formCount = $('#id_items-TOTAL_FORMS').val();
    var newFormIndex = parseInt(formCount);
    
    // Crear nueva fila con todos los campos
    var newRow = $('<tr class="item-row" data-form-index="' + newFormIndex + '">' +
        '<td><select id="id_items-' + newFormIndex + '-producto" name="items-' + newFormIndex + '-producto" class="form-control"></select></td>' +
        '<td><input type="text" id="id_items-' + newFormIndex + '-numero_lote" name="items-' + newFormIndex + '-numero_lote" class="form-control"></td>' +
        '<td><input type="date" id="id_items-' + newFormIndex + '-fecha_caducidad" name="items-' + newFormIndex + '-fecha_caducidad" class="form-control"></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-cantidad_emitida" name="items-' + newFormIndex + '-cantidad_emitida" class="form-control"></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-cantidad_recibida" name="items-' + newFormIndex + '-cantidad_recibida" class="form-control cantidad-recibida"></td>' +
        '<td><input type="number" id="id_items-' + newFormIndex + '-piezas_por_lote" name="items-' + newFormIndex + '-piezas_por_lote" class="form-control piezas-por-lote" min="1" value="1"></td>' +
        '<td><input type="text" id="id_items-' + newFormIndex + '-marca" name="items-' + newFormIndex + '-marca" class="form-control"></td>' +
        '<td><button type="button" class="btn-remove-item" onclick="removeRow(this)">Eliminar</button></td>' +
        '</tr>');
    
    $('#items-tbody').append(newRow);
    
    // Actualizar el contador de formularios
    $('#id_items-TOTAL_FORMS').val(newFormIndex + 1);
    
    // Inicializar Select2 para el nuevo campo
    var newSelect = newRow.find('select[id$="-producto"]');
    newSelect.select2({
        dropdownParent: $('body'),
        width: '100%',
        placeholder: 'Selecciona un producto...'
    });
    
    // Cargar opciones de productos
    $.ajax({
        url: '/api/productos/',
        type: 'GET',
        success: function(data) {
            $.each(data, function(index, producto) {
                newSelect.append('<option value="' + producto.id + '">' + producto.descripcion + '</option>');
            });
        }
    });
    
    // Agregar validación a los nuevos campos
    addFieldValidation(newRow);
}

function removeRow(btn) {
    $(btn).closest('tr').remove();
    updateFormCount();
}

function updateFormCount() {
    var count = $('#items-tbody tr').length;
    $('#id_items-TOTAL_FORMS').val(count);
}

function addFieldValidation(row) {
    // Validar que cantidad_recibida <= cantidad_emitida
    row.find('.cantidad-recibida').on('change', function() {
        var cantEmitida = row.find('input[name$="-cantidad_emitida"]').val();
        var cantRecibida = $(this).val();
        if (parseInt(cantRecibida) > parseInt(cantEmitida)) {
            $(this).css('border-color', 'red');
            $(this).after('<div class="validation-error">No puede ser mayor a cantidad emitida</div>');
        } else {
            $(this).css('border-color', '');
            $(this).siblings('.validation-error').remove();
        }
    });
}

function validatePiezasSum() {
    // Validar que la suma de piezas_por_lote sea igual a cantidad_recibida
    var isValid = true;
    $('#items-tbody tr').each(function() {
        var cantRecibida = parseInt($(this).find('input[name$="-cantidad_recibida"]').val()) || 0;
        var piezasLote = parseInt($(this).find('input[name$="-piezas_por_lote"]').val()) || 0;
        
        if (cantRecibida > 0 && piezasLote !== cantRecibida) {
            $(this).find('input[name$="-piezas_por_lote"]').css('border-color', 'red');
            isValid = false;
        } else {
            $(this).find('input[name$="-piezas_por_lote"]').css('border-color', '');
        }
    });
    return isValid;
}
</script>
{% endblock %}
{% endblock %}
