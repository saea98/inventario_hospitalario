{% load crispy_forms_tags %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
<style>
    .datos-llegada-section {
        background-color: #e8f4f8;
        padding: 15px;
        border-left: 4px solid #0066cc;
        margin-bottom: 20px;
    }
    
    .table-items {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .table-items th {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        text-align: left;
        font-weight: bold;
        font-size: 0.85rem;
    }
    
    .table-items td {
        border: 1px solid #dee2e6;
        padding: 6px;
    }
    
    .table-items input,
    .table-items select {
        width: 100%;
        padding: 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 0.85rem;
    }
    
    .table-items .select2-container {
        width: 100% !important;
    }
    
    .row-principal {
        background-color: #ffffff;
    }
    
    .folio-display {
        padding: 8px 12px;
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 3px;
        color: #495057;
    }
    
    .validation-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-12">
            <h2 class="mb-0">ðŸ“¥ Crear Nueva Llegada de Proveedor</h2>
            <p class="text-muted">Fase 2.2.2 - RecepciÃ³n de MercancÃ­a</p>
        </div>
    </div>
    
    <form method="post" id="llegada-form">
        {% csrf_token %}
        
        <!-- Datos de Llegada -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">ðŸ“‹ Datos de la Llegada</h6>
            </div>
            <div class="card-body">
                <div class="datos-llegada-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_cita"><strong>Cita Autorizada *</strong></label>
                                {{ form.cita }}
                                {% if form.cita.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.cita.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Folio de Llegada</strong></label>
                                <div class="folio-display" id="folio-display">Se genera automÃ¡ticamente</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_remision"><strong>RemisiÃ³n *</strong></label>
                                {{ form.remision }}
                                {% if form.remision.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.remision.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="id_almacen"><strong>AlmacÃ©n *</strong></label>
                                {{ form.almacen }}
                                {% if form.almacen.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.almacen.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="id_numero_piezas_emitidas"><strong>Piezas Emitidas *</strong></label>
                                {{ form.numero_piezas_emitidas }}
                                {% if form.numero_piezas_emitidas.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.numero_piezas_emitidas.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="id_numero_piezas_recibidas"><strong>Piezas Recibidas *</strong></label>
                                {{ form.numero_piezas_recibidas }}
                                {% if form.numero_piezas_recibidas.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.numero_piezas_recibidas.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="id_tipo_red"><strong>Tipo de Red</strong></label>
                                {{ form.tipo_red }}
                                {% if form.tipo_red.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.tipo_red.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Orden de Suministro (Referencia)</strong></label>
                                <div class="form-control" id="orden-suministro-ref" style="background-color: #f8f9fa; color: #666;">-</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Clave de Producto (Referencia)</strong></label>
                                <div class="form-control" id="clave-producto-ref" style="background-color: #f8f9fa; color: #666;">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_observaciones_recepcion"><strong>Observaciones</strong></label>
                        {{ form.observaciones_recepcion }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Items de Llegada -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">ðŸ“¦ Items de la Llegada (Captura RÃ¡pida)</h6>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                
                <div class="table-responsive">
                    <table class="table-items">
                        <thead>
                            <tr>
                                <th colspan="8" style="background-color: #e8f4f8; text-align: center; font-weight: bold;">DATOS DEL LOTE</th>
                                <th colspan="4" style="background-color: #fff3cd; text-align: center; font-weight: bold;">CANTIDADES</th>
                            </tr>
                            <tr>
                                <th>Producto</th>
                                <th>Clave CNIS</th>
                                <th>Lote</th>
                                <th>Fabricante</th>
                                <th>Fecha Fab.</th>
                                <th>% IVA</th>
                                <th>P. Unitario</th>
                                <th>P. c/IVA</th>
                                <th>Emitidas</th>
                                <th>Recibidas</th>
                                <th>Piezas/Lote</th>
                                <th>AcciÃ³n</th>
                            </tr>
                        </thead>
                        <tbody id="items-tbody">
                            {% for form in formset %}
                                {% if not form.instance.pk %}
                                <tr class="row-principal">
                                    <td>{{ form.producto }}</td>
                                    <td><input type="text" id="id_{{ forloop.counter0 }}-clave" name="{{ forloop.counter0 }}-clave" class="form-control clave-input" placeholder="Clave"></td>
                                    <td>{{ form.numero_lote }}</td>
                                    <td><input type="text" id="id_{{ forloop.counter0 }}-fabricante" name="{{ forloop.counter0 }}-fabricante" class="form-control" placeholder="Fabricante"></td>
                                    <td><input type="date" id="id_{{ forloop.counter0 }}-fecha-fab" name="{{ forloop.counter0 }}-fecha-fab" class="form-control"></td>
                                    <td><input type="number" id="id_{{ forloop.counter0 }}-iva-pct" name="{{ forloop.counter0 }}-iva-pct" class="form-control iva-pct" value="0" readonly></td>
                                    <td><input type="number" id="id_{{ forloop.counter0 }}-precio-unitario" name="{{ forloop.counter0 }}-precio-unitario" class="form-control precio-unitario" step="0.01" placeholder="0.00"></td>
                                    <td><input type="number" id="id_{{ forloop.counter0 }}-precio-iva" name="{{ forloop.counter0 }}-precio-iva" class="form-control precio-iva" step="0.01" readonly></td>
                                    <td>{{ form.cantidad_emitida }}</td>
                                    <td>{{ form.cantidad_recibida }}</td>
                                    <td>{{ form.piezas_por_lote }}</td>
                                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)">âœ•</button></td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <button type="button" class="btn btn-sm btn-primary mt-3" onclick="addItem()">+ Agregar Item</button>
            </div>
        </div>
        
        <!-- Botones -->
        <div class="row mb-4">
            <div class="col-md-12">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-save"></i> Guardar Llegada
                </button>
                <a href="{% url 'logistica:llegadas:lista_llegadas' %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar Select2
    $('#id_cita, #id_almacen').select2({
        width: '100%',
        language: 'es'
    });
    
    // Cargar datos de cita cuando se selecciona
    $('#id_cita').on('change', function() {
        var citaId = $(this).val();
        if (citaId) {
            $.ajax({
                url: '/logistica/llegadas/api/cita/' + citaId + '/folio/',
                type: 'GET',
                success: function(data) {
                    $('#folio-display').text(data.folio || 'Se genera automÃ¡ticamente');
                    if (data.remision) $('#id_remision').val(data.remision);
                    if (data.orden_suministro) {
                        $('#id_numero_orden_suministro').val(data.orden_suministro);
                        $('#orden-suministro-ref').text(data.orden_suministro);
                    }
                    if (data.contrato) $('#id_numero_contrato').val(data.contrato);
                    if (data.almacen_id) $('#id_almacen').val(data.almacen_id).trigger('change');
                    if (data.clave_medicamento) {
                        $('#clave-producto-ref').text(data.clave_medicamento);
                        window.citaClaveDefault = data.clave_medicamento;
                        // Llenar clave en todos los inputs
                        $('.clave-input').each(function() {
                            if (!$(this).val()) {
                                $(this).val(data.clave_medicamento);
                            }
                        });
                    }
                },
                error: function() {
                    console.log('Error al cargar datos de cita');
                }
            });
        }
    });
    
    // Calcular IVA segÃºn clave
    $(document).on('change', '.clave-input', function() {
        var clave = $(this).val();
        var row = $(this).closest('tr');
        var ivaInput = row.find('.iva-pct');
        
        if (clave && (clave.startsWith('060') || clave.startsWith('080') || clave.startsWith('130') || clave.startsWith('379'))) {
            ivaInput.val(16);
        } else {
            ivaInput.val(0);
        }
        
        // Recalcular precio con IVA
        calcularPrecioConIVA(row);
    });
    
    // Calcular precio con IVA
    $(document).on('change', '.precio-unitario, .iva-pct', function() {
        var row = $(this).closest('tr');
        calcularPrecioConIVA(row);
    });
    
    function calcularPrecioConIVA(row) {
        var precioUnitario = parseFloat(row.find('.precio-unitario').val()) || 0;
        var ivaPct = parseFloat(row.find('.iva-pct').val()) || 0;
        var precioConIVA = precioUnitario * (1 + (ivaPct / 100));
        row.find('.precio-iva').val(precioConIVA.toFixed(2));
    }
});

function addItem() {
    // Agregar nuevo item
    var newRow = '<tr class="row-principal"><td><input type="text" class="form-control" placeholder="Producto"></td><td><input type="text" class="form-control clave-input" placeholder="Clave"></td><td><input type="text" class="form-control" placeholder="Lote"></td><td><input type="text" class="form-control" placeholder="Fabricante"></td><td><input type="date" class="form-control"></td><td><input type="number" class="form-control iva-pct" value="0" readonly></td><td><input type="number" class="form-control precio-unitario" step="0.01" placeholder="0.00"></td><td><input type="number" class="form-control precio-iva" step="0.01" readonly></td><td><input type="number" class="form-control" placeholder="0"></td><td><input type="number" class="form-control" placeholder="0"></td><td><input type="number" class="form-control" placeholder="0"></td><td><button type="button" class="btn btn-sm btn-danger" onclick="removeItem(this)">âœ•</button></td></tr>';
    $('#items-tbody').append(newRow);
    
    // Llenar clave default si existe
    if (window.citaClaveDefault) {
        $('#items-tbody tr:last .clave-input').val(window.citaClaveDefault);
    }
}

function removeItem(btn) {
    $(btn).closest('tr').remove();
}
</script>
{% endblock %}
