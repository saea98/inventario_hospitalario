{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-rc.0/css/select2.min.css" rel="stylesheet" />
<style>
    .datos-llegada-section {
        background-color: #e8f4f8;
        padding: 15px;
        border-left: 4px solid #0066cc;
        margin-bottom: 20px;
    }
    
    .table-items {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    
    .table-items th {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        text-align: left;
        font-weight: bold;
        font-size: 0.85rem;
    }
    
    .table-items td {
        border: 1px solid #dee2e6;
        padding: 6px;
    }
    
    .table-items input,
    .table-items select {
        width: 100%;
        padding: 4px;
        border: 1px solid #ced4da;
        border-radius: 3px;
        font-size: 0.85rem;
    }
    
    .table-items .select2-container {
        width: 100% !important;
    }
    
    .row-principal {
        background-color: #ffffff;
    }
    
    /* Estilos para campos obligatorios - FORCE UPDATE v2 */
    .form-group.required-field .form-control,
    .form-group.required-field .select2-container--default .select2-selection--single {
        border: 2px solid #ffc107 !important;
        background-color: #fffbf0 !important;
    }
    
    .form-group.required-field.filled .form-control,
    .form-group.required-field.filled .select2-container--default .select2-selection--single {
        border: 2px solid #28a745 !important;
        background-color: #f0fff4 !important;
    }
    
    .form-group.required-field label::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }
    
    .form-group.required-field {
        padding: 10px;
        border-radius: 4px;
        background-color: rgba(255, 193, 7, 0.05);
    }
    
    .form-group.required-field.filled {
        background-color: rgba(40, 167, 69, 0.05);
    }
    
    .validation-error-highlight {
        border: 2px solid #dc3545 !important;
        background-color: #fff5f5 !important;
    }
    
    .row-precios {
        background-color: #f9f9f9;
    }
    
    .btn-remove-item {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 4px 8px;
        cursor: pointer;
        border-radius: 3px;
        font-size: 0.85rem;
    }
    
    .btn-remove-item:hover {
        background-color: #c82333;
    }
    
    .validation-error {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }
    
    .campo-calculado {
        background-color: #f0f0f0;
        font-weight: bold;
    }
    
    .campo-editable {
        background-color: #ffffff;
    }
    
    .folio-display {
        background-color: #e8f4f8;
        padding: 8px;
        border-radius: 3px;
        font-weight: bold;
        color: #0066cc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-2 text-gray-800">Registrar Nueva Llegada de Proveedor</h1>
    <p class="mb-4">Completa los datos para registrar una nueva llegada. Los campos verdes son de captura obligatoria.</p>

    <form method="post" id="llegada-form">
        {% csrf_token %}
        
        <!-- Mostrar errores generales del formulario -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h5>Errores en el formulario:</h5>
                {% for error in form.non_field_errors %}
                    <div>â€¢ {{ error }}</div>
                {% endfor %}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endif %}
        
        <!-- Mostrar errores de campos individuales -->
        {% for field in form %}
            {% if field.errors %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <strong>{{ field.label|default:field.name }}:</strong> {{ field.errors }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endif %}
        {% endfor %}
        
        <!-- Mostrar errores del formset items -->
        {% if formset.non_form_errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h5>Errores en los items:</h5>
                {% for error in formset.non_form_errors %}
                    <div>â€¢ {{ error }}</div>
                {% endfor %}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endif %}
        
        {% for form_item in formset %}
            {% if form_item.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <h5>Error en item:</h5>
                    {% for field in form_item %}
                        {% if field.errors %}
                            <div><strong>{{ field.label|default:field.name }}:</strong> {{ field.errors }}</div>
                        {% endif %}
                    {% endfor %}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endif %}
        {% endfor %}
        
        <!-- Datos de Llegada -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">ðŸ“‹ Datos de la Llegada</h6>
            </div>
            <div class="card-body">
                <div class="datos-llegada-section">
                    <!-- Campo hidden para proveedor -->
                    {{ form.proveedor }}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group required-field" data-field="cita">
                                <label for="id_cita"><strong>Cita Autorizada</strong></label>
                                {{ form.cita }}
                                {% if form.cita.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.cita.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Folio de Llegada</strong></label>
                                <div class="folio-display" id="folio-display">Se genera automÃ¡ticamente</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group required-field" data-field="remision">
                                <label for="id_remision"><strong>RemisiÃ³n</strong></label>
                                {{ form.remision }}
                                {% if form.remision.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.remision.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group required-field" data-field="almacen">
                                <label for="id_almacen"><strong>AlmacÃ©n</strong></label>
                                {{ form.almacen }}
                                {% if form.almacen.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.almacen.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group required-field" data-field="numero_piezas_emitidas">
                                <label for="id_numero_piezas_emitidas"><strong>Piezas Emitidas</strong></label>
                                {{ form.numero_piezas_emitidas }}
                                {% if form.numero_piezas_emitidas.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.numero_piezas_emitidas.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group required-field" data-field="numero_piezas_recibidas">
                                <label for="id_numero_piezas_recibidas"><strong>Piezas Recibidas</strong></label>
                                {{ form.numero_piezas_recibidas }}
                                <small class="form-text text-muted">Se calcula automÃ¡ticamente desde los items</small>
                                {% if form.numero_piezas_recibidas.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.numero_piezas_recibidas.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="id_tipo_red"><strong>Tipo de Red</strong></label>
                                {{ form.tipo_red }}
                                {% if form.tipo_red.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.tipo_red.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label><strong>Clave de Producto (Referencia)</strong></label>
                                <div class="form-control" id="clave-producto-ref" style="background-color: #f8f9fa; color: #666; padding: 8px;">
                                    {% if llegada.cita and llegada.cita.clave_medicamento %}
                                        {{ llegada.cita.clave_medicamento }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {% if form.tipo_entrega %}
                                    <label for="id_tipo_entrega"><strong>Tipo de Entrega</strong></label>
                                    {{ form.tipo_entrega }}
                                    {% if form.tipo_entrega.errors %}
                                        <div class="alert alert-danger mt-2">{{ form.tipo_entrega.errors }}</div>
                                    {% endif %}
                                {% else %}
                                    <label><strong>Tipo de Entrega</strong></label>
                                    <div class="form-control" style="background-color: #f8f9fa; color: #666; padding: 8px;">
                                        {% if llegada.cita and llegada.cita.tipo_entrega %}
                                            {% for tipo_val, tipo_label, _ in llegada.cita.TIPOS_ENTREGA %}
                                                {% if tipo_val == llegada.cita.tipo_entrega %}
                                                    {{ tipo_label }}
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            No disponible
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_observaciones_recepcion"><strong>Observaciones</strong></label>
                        {{ form.observaciones_recepcion }}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="id_numero_orden_suministro"><strong>Orden de Suministro</strong></label>
                                {{ form.numero_orden_suministro }}
                                {% if form.numero_orden_suministro.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.numero_orden_suministro.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="id_numero_contrato"><strong>NÃºmero de Contrato</strong></label>
                                {{ form.numero_contrato }}
                                {% if form.numero_contrato.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.numero_contrato.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="id_numero_procedimiento"><strong>NÃºmero de Procedimiento</strong></label>
                                {{ form.numero_procedimiento }}
                                {% if form.numero_procedimiento.errors %}
                                    <div class="alert alert-danger mt-2">{{ form.numero_procedimiento.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items de Llegada -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">ðŸ“¦ Items de la Llegada (Captura RÃ¡pida)</h6>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                
                <div class="table-responsive">
                    <table class="table-items">
                        <thead style="display: none;"></thead>
                        <tbody id="items-tbody">
                            {% for form in formset %}
                                {% if not form.DELETE.value %}
                                <!-- FILA 1: Datos del Lote y Cantidades -->
                                <tr class="item-row row-principal" data-form-index="{{ forloop.counter0 }}" 
                                    data-item-id="{% if form.instance.pk %}{{ form.instance.pk }}{% endif %}"
                                    data-producto-id="{% if form.instance.producto_id %}{{ form.instance.producto_id }}{% endif %}">
                                    <td><small class="text-muted d-block mb-1">Producto</small>{{ form.producto }}</td>
                                    <td><small class="text-muted d-block mb-1">Lote</small>{{ form.numero_lote }}</td>
                                    <td><small class="text-muted d-block mb-1">F. Caduc.</small>{{ form.fecha_caducidad }}</td>
                                    <td><small class="text-muted d-block mb-1">F. de FabricaciÃ³n</small>{{ form.fecha_elaboracion }}</td>
                                    <td><small class="text-muted d-block mb-1">Marca</small>{{ form.marca }}</td>
                                    <td><small class="text-muted d-block mb-1">Fabricante</small>{{ form.fabricante }}</td>
                                    <td><small class="text-muted d-block mb-1">Recibida</small>{{ form.cantidad_recibida }}</td>
                                    <!-- Campo oculto para clave -->
                                    <td style="display: none;">{{ form.clave }}</td>
                                    <!-- Campo oculto para cantidad emitida -->
                                    <td style="display: none;"><small class="text-muted d-block mb-1">Emitida</small>{{ form.cantidad_emitida }}</td>
                                    <td style="display: none;"><small class="text-muted d-block mb-1">Piezas/Lote</small>{{ form.piezas_por_lote }}</td>
                                    <!-- Campo oculto DELETE -->
                                    <td style="display: none;">{{ form.DELETE }}</td>
                                    <!-- Campo oculto ID -->
                                    <td style="display: none;">{{ form.id }}</td>
                                    <td>
                                        {% if not forloop.first %}
                                            <button type="button" class="btn-remove-item" onclick="removeRow(this)">Eliminar</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                
                                <!-- FILA 2: Precios e IVA -->
                                <tr class="item-row row-precios" data-form-index="{{ forloop.counter0 }}">
                                    <td><small class="text-muted d-block mb-1">P. Unitario</small><input type="number" id="{{ form.precio_unitario_sin_iva.id_for_label }}" name="{{ form.precio_unitario_sin_iva.html_name }}" class="form-control precio-unitario" step="0.01" placeholder="0.00" value="{{ form.precio_unitario_sin_iva.value|default:'' }}"></td>
                                    <td><small class="text-muted d-block mb-1">% IVA</small><input type="number" id="{{ form.porcentaje_iva.id_for_label }}" name="{{ form.porcentaje_iva.html_name }}" class="form-control porcentaje-iva" step="0.01" placeholder="0.00" value="{{ form.porcentaje_iva.value|default:'' }}" readonly></td>
                                    <td><small class="text-muted d-block mb-1">P. c/IVA</small><input type="number" id="{{ form.precio_unitario_con_iva.id_for_label }}" name="{{ form.precio_unitario_con_iva.html_name }}" class="form-control precio-con-iva" step="0.01" placeholder="0.00" value="{{ form.precio_unitario_con_iva.value|default:'' }}" readonly></td>
                                    <td><small class="text-muted d-block mb-1">Subtotal</small><input type="number" id="{{ form.subtotal.id_for_label }}" name="{{ form.subtotal.html_name }}" class="form-control subtotal" step="0.01" placeholder="0.00" value="{{ form.subtotal.value|default:'' }}" readonly></td>
                                    <td><small class="text-muted d-block mb-1">Importe IVA</small><input type="number" id="{{ form.importe_iva.id_for_label }}" name="{{ form.importe_iva.html_name }}" class="form-control importe-iva" step="0.01" placeholder="0.00" value="{{ form.importe_iva.value|default:'' }}" readonly></td>
                                    <td><small class="text-muted d-block mb-1">Total</small><input type="number" id="{{ form.importe_total.id_for_label }}" name="{{ form.importe_total.html_name }}" class="form-control importe-total" step="0.01" placeholder="0.00" value="{{ form.importe_total.value|default:'' }}" readonly></td>
                                    <td colspan="3"></td>
                                </tr>
                                
                                {% if form.non_field_errors %}
                                    <tr>
                                        <td colspan="12" class="alert alert-danger">
                                            {{ form.non_field_errors }}
                                        </td>
                                    </tr>
                                {% endif %}
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <button type="button" id="add-item-btn" class="btn btn-success btn-sm mt-3">+ Agregar Lote</button>
                <div id="validation-message" class="alert alert-warning mt-3" style="display: none;"></div>
            </div>
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-primary btn-lg">ðŸ’¾ Guardar Llegada</button>
            <a href="{% url 'logistica:llegadas:lista_llegadas' %}" class="btn btn-secondary btn-lg">Cancelar</a>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('[ONLOAD] Document ready - Iniciando inicializaciÃ³n de Select2');
    
    // Inicializar Select2
    $('#id_cita').select2({
        dropdownParent: $('body'),
        width: '100%'
    });
    
    $('#id_almacen').select2({
        dropdownParent: $('body'),
        width: '100%'
    });
    
    // Verificar selects de productos ANTES de inicializar
    var selectsProducto = $('select[id$="-producto"]');
    console.log('[ONLOAD] Total selects de producto encontrados:', selectsProducto.length);
    
    selectsProducto.each(function(index) {
        var $select = $(this);
        var $row = $select.closest('tr.item-row.row-principal');
        var itemId = $row.data('item-id');
        var productoIdFromData = $row.data('producto-id');
        var valor = $select.val();
        var $optionSelected = $select.find('option:selected');
        var textoSelected = $optionSelected.text();
        var totalOpciones = $select.find('option').length;
        
        console.log('[ONLOAD] Select ' + index + ' (ID: ' + $select.attr('id') + '):');
        console.log('  - Item ID (desde data):', itemId);
        console.log('  - Producto ID (desde data):', productoIdFromData);
        console.log('  - Valor:', valor);
        console.log('  - Texto seleccionado:', textoSelected);
        console.log('  - Total opciones:', totalOpciones);
        console.log('  - Tiene selected attribute:', $optionSelected.length > 0 && $optionSelected.attr('selected') !== undefined);
        
        // Log informaciÃ³n del item (sin alert para no interrumpir)
        console.log('[ONLOAD] Item #' + (index + 1) + ' - Item ID:', itemId, 'Producto ID (data):', productoIdFromData);
    });
    
    // Esperar a que base.html termine de inicializar Select2 automÃ¡ticamente
    // base.html inicializa Select2 para todos los selects, asÃ­ que necesitamos esperar
    // y luego re-inicializar o actualizar los selects de productos con el valor correcto
    // TambiÃ©n esperamos a que window.productosData estÃ© cargado para poder buscar por clave
    setTimeout(function() {
        console.log('[ONLOAD] Llamando a initializeProductSelect2() despuÃ©s de que base.html inicialice');
        initializeProductSelect2();
        
        // DespuÃ©s de inicializar, esperar un poco mÃ¡s y recalcular IVA para todos los selects con valor
        // Esto asegura que el IVA se calcule incluso si los productos se preseleccionaron antes de que window.productosData estuviera disponible
        setTimeout(function() {
            console.log('[ONLOAD] Recalculando IVA para todos los selects despuÃ©s de initializeProductSelect2');
            $('select[id$="-producto"]').each(function() {
                var $select = $(this);
                var valor = $select.val();
                if (valor && valor !== '' && valor !== null) {
                    console.log('[ONLOAD] Disparando change para select:', $select.attr('id'), 'Valor:', valor);
                    $select.trigger('change');
                }
            });
        }, 800);
    }, 500);
    
    // Cargar productos desde la API para tenerlos en window.productosData
    // Esto es necesario para cÃ¡lculos de IVA y para nuevos items
    $.ajax({
        url: '/logistica/llegadas/api/productos/',
        type: 'GET',
        success: function(data) {
            console.log('[AJAX] Productos cargados:', data.length);
            // Guardar los datos de productos para acceso posterior
            if (!window.productosData) {
                window.productosData = {};
            }
            
            // Guardar todos los productos en window.productosData
            $.each(data, function(index, producto) {
                window.productosData[producto.id] = producto;
            });
            
            console.log('[editar_llegada] Productos cargados en window.productosData:', Object.keys(window.productosData).length);
            
            // DespuÃ©s de cargar productos, forzar actualizaciÃ³n de Select2 si hay valores
            // Esto asegura que si algÃºn valor no se mostrÃ³ correctamente, se actualice
            setTimeout(function() {
                $('select[id$="-producto"]').each(function() {
                    var $select = $(this);
                    var valor = $select.val();
                    if (valor) {
                        // Forzar actualizaciÃ³n del display
                        $select.trigger('change');
                    }
                });
            }, 200);
        },
        error: function() {
            console.error('Error al cargar productos para window.productosData');
        }
    });
    
    // Asegurar que todos los campos porcentaje_iva tengan un valor inicial
    $('input[name$="-porcentaje_iva"]').each(function() {
        if (!$(this).val() || $(this).val() === '') {
            // Obtener la clave del producto si estÃ¡ disponible
            var $row = $(this).closest('tr.row-precios');
            var formIndex = $row.data('form-index');
            var $rowPrincipal = $('tr.row-principal[data-form-index="' + formIndex + '"]');
            var $productoSelect = $rowPrincipal.find('select[name$="-producto"]');
            var $claveInput = $rowPrincipal.find('input[name$="-clave"]');
            
            var clave = '';
            if ($claveInput.length && $claveInput.val() && $claveInput.val() !== 'DEFAULT') {
                clave = $claveInput.val();
            } else if ($productoSelect.length && $productoSelect.val()) {
                // Intentar obtener la clave del producto seleccionado
                var selectedText = $productoSelect.find('option:selected').text();
                clave = extraerClaveDelProducto(selectedText);
            }
            
            // Calcular IVA segÃºn la clave
            if (clave && (clave.startsWith('010') || clave.startsWith('020') || clave.startsWith('030') || clave.startsWith('040'))) {
                $(this).val('0');
            } else {
                $(this).val('16');
            }
        }
    });
    
    // Llenar campos por defecto (clave y cantidad_emitida)
    // Esperar un momento para asegurar que todos los datos estÃ©n cargados
    setTimeout(function() {
        fillDefaultFieldValues();
    }, 300);
    
    // Calcular total de piezas recibidas al cargar la pÃ¡gina
    updateTotalPiezasRecibidas();
    
    // Llenar precios unitarios con el valor del item anterior
    fillPreciosFromPreviousItem();
    
    // En modo ediciÃ³n, NO disparar el evento change automÃ¡ticamente
    // Esto evita sobrescribir valores guardados con los valores de la cita
    // Los valores guardados en la llegada tienen prioridad sobre los de la cita
    
    // Agregar evento global para cambios en cantidad_recibida
    $(document).on('change', '.cantidad-recibida', function() {
        console.log('Cambio detectado en cantidad_recibida:', $(this).val());
        
        // Actualizar cantidad_emitida con el mismo valor
        var $row = $(this).closest('tr');
        var formIndex = $row.data('form-index');
        var cantidadRecibida = $(this).val();
        var $cantidadEmitidaField = $row.find('input[name="items-' + formIndex + '-cantidad_emitida"]');
        if ($cantidadEmitidaField.length) {
            $cantidadEmitidaField.val(cantidadRecibida);
        }
        
        updateTotalPiezasRecibidas();
    });
    
    // Agregar nueva fila
    $('#add-item-btn').click(function(e) {
        e.preventDefault();
        addItemRow();
    });
    
    // Validar campos obligatorios y mostrar visualmente cuales faltan
    function validateRequiredFields() {
        var requiredFields = ['cita', 'remision', 'numero_piezas_emitidas', 'numero_piezas_recibidas', 'almacen'];
        var emptyFields = [];
        
        requiredFields.forEach(function(fieldName) {
            var $field = $('[name="' + fieldName + '"]');
            var $formGroup = $field.closest('.form-group');
            var value = $field.val();
            
            if (!value || value.trim() === '') {
                emptyFields.push(fieldName);
                $formGroup.addClass('validation-error-highlight');
            } else {
                $formGroup.removeClass('validation-error-highlight');
            }
        });
        
        if (emptyFields.length > 0) {
            var fieldLabels = emptyFields.map(function(f) {
                return $('[name="' + f + '"]').closest('.form-group').find('label').text() || f;
            }).join(', ');
            showValidationMessage('Campos obligatorios faltantes: ' + fieldLabels);
            return false;
        }
        return true;
    }
    
    // Monitorear cambios en campos obligatorios
    $('.required-field').each(function() {
        var $field = $(this).find('input, select, textarea');
        $field.on('change input', function() {
            var value = $(this).val();
            if (value && value.trim() !== '') {
                $(this).closest('.form-group').addClass('filled').removeClass('validation-error-highlight');
            } else {
                $(this).closest('.form-group').removeClass('filled');
            }
        });
    });
    
    // Validar al enviar
    $('#llegada-form').on('submit', function(e) {
        // Asegurar que todos los campos porcentaje_iva tengan un valor
        $('input[name$="-porcentaje_iva"]').each(function() {
            if (!$(this).val() || $(this).val() === '') {
                var $row = $(this).closest('tr.row-precios');
                var formIndex = $row.data('form-index');
                var $rowPrincipal = $('tr.row-principal[data-form-index="' + formIndex + '"]');
                var $productoSelect = $rowPrincipal.find('select[name$="-producto"]');
                var $claveInput = $rowPrincipal.find('input[name$="-clave"]');
                
                var clave = '';
                if ($claveInput.length && $claveInput.val() && $claveInput.val() !== 'DEFAULT') {
                    clave = $claveInput.val();
                } else if ($productoSelect.length && $productoSelect.val()) {
                    var selectedText = $productoSelect.find('option:selected').text();
                    clave = extraerClaveDelProducto(selectedText);
                }
                
            // Calcular IVA segÃºn la clave
            if (clave && (clave.startsWith('010') || clave.startsWith('020') || clave.startsWith('030') || clave.startsWith('040'))) {
                $(this).val('0');
            } else {
                $(this).val('16');
            }
            }
        });
        
        if (!validateRequiredFields() || !validatePiezasSum()) {
            e.preventDefault();
        }
    });
    
    // Cargar datos de cita cuando se selecciona (solo si los campos estÃ¡n vacÃ­os)
    $('#id_cita').on('change', function() {
        var citaId = $(this).val();
        if (citaId) {
            $.ajax({
                url: '/logistica/llegadas/api/cita/' + citaId + '/folio/',
                type: 'GET',
                success: function(data) {
                    $('#folio-display').text(data.folio || 'Se genera automÃ¡ticamente');
                    
                    // Solo llenar remisiÃ³n si estÃ¡ vacÃ­a
                    if (data.remision && !$('#id_remision').val()) {
                        $('#id_remision').val(data.remision);
                    }
                    
                    // Solo llenar orden de suministro si estÃ¡ vacÃ­o (NO sobrescribir valores guardados)
                    if (data.orden_suministro && !$('#id_numero_orden_suministro').val()) {
                        $('#id_numero_orden_suministro').val(data.orden_suministro);
                    }
                    
                    // Solo llenar contrato si estÃ¡ vacÃ­o
                    if (data.contrato && !$('#id_numero_contrato').val()) {
                        $('#id_numero_contrato').val(data.contrato);
                    }
                    
                    if (data.almacen_id) $('#id_almacen').val(data.almacen_id).trigger('change');
                    if (data.proveedor_id) $('#id_proveedor').val(data.proveedor_id);
                    if (data.clave_medicamento) {
                        $('#clave-producto-ref').text(data.clave_medicamento);
                        window.citaClaveDefault = data.clave_medicamento;
                        console.log('[onchange cita] Clave de cita establecida:', window.citaClaveDefault);
                        
                        // Actualizar las claves de los items existentes que tienen "DEFAULT"
                        setTimeout(function() {
                            fillDefaultFieldValues();
                        }, 200);
                        
                        // Pre-seleccionar producto con esta clave en todos los selects (solo si no tienen valor)
                        $('select[id$="-producto"]').each(function() {
                            var $select = $(this);
                            if (!$select.val()) {  // Solo si el select no tiene valor seleccionado
                                var $option = $select.find('option').filter(function() {
                                    return $(this).text().includes(data.clave_medicamento);
                                }).first();
                                if ($option.length) {
                                    $select.val($option.val()).trigger('change');
                                }
                            }
                        });
                    }
                },
                error: function() {
                    console.log('Error al cargar datos de cita');
                }
            });
        }
    });
    
    // Cargar datos de cita automÃ¡ticamente al cargar la pÃ¡gina si la llegada tiene una cita asociada
    // Esto asegura que los datos de la cita se muestren incluso si la llegada fue creada con datos incompletos
    var citaIdActual = $('#id_cita').val();
    if (citaIdActual) {
        $.ajax({
            url: '/logistica/llegadas/api/cita/' + citaIdActual + '/folio/',
            type: 'GET',
            success: function(data) {
                $('#folio-display').text(data.folio || 'Se genera automÃ¡ticamente');
                
                // Actualizar clave de producto si estÃ¡ disponible y el campo estÃ¡ vacÃ­o o tiene "-"
                if (data.clave_medicamento && ($('#clave-producto-ref').text().trim() === '-' || $('#clave-producto-ref').text().trim() === '')) {
                    $('#clave-producto-ref').text(data.clave_medicamento);
                }
                
                // Establecer la clave de la cita para usar en los items
                if (data.clave_medicamento) {
                    window.citaClaveDefault = data.clave_medicamento;
                    console.log('[editar_llegada] Clave de cita establecida:', window.citaClaveDefault);
                }
                
                // Si los campos estÃ¡n vacÃ­os, llenarlos con los datos de la cita
                // Esto corrige el problema cuando la llegada fue creada con datos incompletos en validar_entrada
                if (data.remision && !$('#id_remision').val()) {
                    $('#id_remision').val(data.remision);
                }
                if (data.orden_suministro && !$('#id_numero_orden_suministro').val()) {
                    $('#id_numero_orden_suministro').val(data.orden_suministro);
                }
                if (data.contrato && !$('#id_numero_contrato').val()) {
                    $('#id_numero_contrato').val(data.contrato);
                }
                if (data.almacen_id && !$('#id_almacen').val()) {
                    $('#id_almacen').val(data.almacen_id).trigger('change');
                }
                if (data.proveedor_id && !$('#id_proveedor').val()) {
                    $('#id_proveedor').val(data.proveedor_id);
                }
                
                // Actualizar las claves de los items que tienen "DEFAULT"
                // Esperar un poco mÃ¡s para asegurar que todos los elementos del DOM estÃ©n listos
                setTimeout(function() {
                    console.log('[editar_llegada] Ejecutando fillDefaultFieldValues despuÃ©s de cargar datos de cita');
                    fillDefaultFieldValues();
                }, 800);
            }
        });
    } else {
        // Si no hay cita, intentar obtener la clave desde el campo clave-producto-ref
        var claveRef = $('#clave-producto-ref').text().trim();
        if (claveRef && claveRef !== '-') {
            window.citaClaveDefault = claveRef;
            console.log('[editar_llegada] Clave obtenida del campo ref:', window.citaClaveDefault);
            setTimeout(function() {
                fillDefaultFieldValues();
            }, 500);
        }
    }
});


function initializeProductSelect2() {
    console.log('[initializeProductSelect2] Iniciando funciÃ³n');
    
    // Obtener la clave del producto desde #clave-producto-ref
    var claveProductoRef = $('#clave-producto-ref').text().trim();
    if (claveProductoRef === '-' || claveProductoRef === '') {
        claveProductoRef = null;
    }
    
    console.log('[initializeProductSelect2] Clave de producto (desde #clave-producto-ref):', claveProductoRef);
    
    // Buscar el producto por clave CNIS en window.productosData
    var productoIdPorClave = null;
    if (claveProductoRef && window.productosData) {
        $.each(window.productosData, function(id, producto) {
            if (producto.clave_cnis === claveProductoRef) {
                productoIdPorClave = id;
                console.log('[initializeProductSelect2] âœ… Producto encontrado por clave:', productoIdPorClave, producto.descripcion);
                return false; // break
            }
        });
        if (!productoIdPorClave) {
            console.warn('[initializeProductSelect2] âš ï¸ No se encontrÃ³ producto con clave:', claveProductoRef);
        }
    }
    
    var selectsProducto = $('select[id$="-producto"]');
    var totalSelects = selectsProducto.length;
    
    console.log('[initializeProductSelect2] Total selects encontrados:', totalSelects);
    console.log('[initializeProductSelect2] Producto ID por clave:', productoIdPorClave);
    
    selectsProducto.each(function(index) {
        var $select = $(this);
        var selectId = $select.attr('id');
        var $row = $select.closest('tr.item-row.row-principal');
        var itemId = $row.data('item-id');
        var productoIdFromData = $row.data('producto-id');
        
        console.log('[initializeProductSelect2] Procesando select ' + index + ': ' + selectId);
        console.log('[initializeProductSelect2] Item ID (desde data):', itemId);
        console.log('[initializeProductSelect2] Producto ID (desde data):', productoIdFromData);
        
        // Leer el valor actual ANTES de inicializar Select2
        var valorActual = $select.val();
        var $optionSeleccionada = $select.find('option:selected');
        var textoSeleccionado = $optionSeleccionada.text();
        
        // Estrategia de preselecciÃ³n (en orden de prioridad):
        // 1. Si el select ya tiene un valor, usarlo
        // 2. Si hay productoIdFromData (del item existente), usarlo
        // 3. Si hay productoIdPorClave (de la clave de la cita), usarlo
        if (!valorActual) {
            if (productoIdFromData) {
                console.log('[initializeProductSelect2] Usando productoIdFromData:', productoIdFromData);
                valorActual = productoIdFromData;
            } else if (productoIdPorClave) {
                console.log('[initializeProductSelect2] Usando productoIdPorClave (de clave):', productoIdPorClave);
                valorActual = productoIdPorClave;
            }
            
            // Si encontramos un valor, establecerlo en el select
            if (valorActual) {
                var $optionConProducto = $select.find('option[value="' + valorActual + '"]');
                if ($optionConProducto.length > 0) {
                    console.log('[initializeProductSelect2] âœ… Estableciendo valor en select:', valorActual);
                    $select.val(valorActual);
                } else {
                    console.warn('[initializeProductSelect2] âš ï¸ OpciÃ³n con value="' + valorActual + '" NO encontrada en el select');
                    valorActual = null; // Resetear si no existe la opciÃ³n
                }
            }
        }
        
        if (!valorActual && $optionSeleccionada.length && $optionSeleccionada.val()) {
            valorActual = $optionSeleccionada.val();
        }
        
        var yaInicializado = $select.hasClass('select2-hidden-accessible');
        var totalOpciones = $select.find('option').length;
        
        console.log('[initializeProductSelect2] Select ' + index + ' - ANTES de procesar:');
        console.log('  - Valor:', valorActual);
        console.log('  - Texto seleccionado:', textoSeleccionado);
        console.log('  - Opciones disponibles:', totalOpciones);
        console.log('  - Select2 ya inicializado:', yaInicializado);
        
        // IMPORTANTE: Configurar eventos ANTES de establecer el valor
        // Limpiar eventos anteriores para evitar duplicados
        $select.off('select2:select select2:unselect change');
        
        // Evento cuando se selecciona una opciÃ³n en Select2
        $select.on('select2:select', function(e) {
            var $selectElement = $(this);
            var valorSeleccionado = $selectElement.val();
            var textoSeleccionado = $selectElement.find('option:selected').text();
            
            console.log('[EVENTO] select2:select disparado para:', $selectElement.attr('id'));
            console.log('[EVENTO] Valor seleccionado:', valorSeleccionado);
            console.log('[EVENTO] Texto seleccionado:', textoSeleccionado);
            
            // Forzar actualizaciÃ³n visual del Select2
            // Select2 deberÃ­a actualizarse automÃ¡ticamente, pero forzamos para asegurar
            $selectElement.trigger('change.select2');
            
            // Verificar que el display se actualizÃ³ correctamente
            setTimeout(function() {
                var displayText = $selectElement.next('.select2-container').find('.select2-selection__rendered').text();
                console.log('[EVENTO] Display despuÃ©s de select:', displayText);
                
                // Si el display no coincide con el texto seleccionado, forzar actualizaciÃ³n
                if (displayText !== textoSeleccionado && textoSeleccionado) {
                    console.warn('[EVENTO] âš ï¸ Display no coincide, forzando actualizaciÃ³n');
                    $selectElement.val(valorSeleccionado).trigger('change.select2');
                }
            }, 100);
            
            // Calcular IVA
            calcularIVADelProducto($selectElement);
        });
        
        // Evento cuando cambia el valor (tambiÃ©n funciona con cambios programÃ¡ticos)
        $select.on('change', function(e) {
            var $selectElement = $(this);
            var valor = $selectElement.val();
            
            console.log('[EVENTO] change disparado para:', $selectElement.attr('id'), 'Valor:', valor);
            
            if (valor && valor !== '' && valor !== null) {
                var textoSeleccionado = $selectElement.find('option:selected').text();
                console.log('[EVENTO] Texto de la opciÃ³n seleccionada:', textoSeleccionado);
                
                // Forzar actualizaciÃ³n visual del Select2
                $selectElement.trigger('change.select2');
                
                // Verificar que el display se actualizÃ³ correctamente
                setTimeout(function() {
                    var displayText = $selectElement.next('.select2-container').find('.select2-selection__rendered').text();
                    console.log('[EVENTO] Display despuÃ©s de change:', displayText);
                    
                    // Si el display no coincide con el texto seleccionado, forzar actualizaciÃ³n
                    if (displayText !== textoSeleccionado && textoSeleccionado) {
                        console.warn('[EVENTO] âš ï¸ Display no coincide en change, forzando actualizaciÃ³n');
                        $selectElement.val(valor).trigger('change.select2');
                    }
                }, 100);
                
                console.log('[EVENTO] Llamando a calcularIVADelProducto desde evento change');
                // Calcular IVA
                calcularIVADelProducto($selectElement);
            } else {
                console.log('[EVENTO] No hay valor, no se calcula IVA');
            }
        });
        
        // Evento cuando se deselecciona
        $select.on('select2:unselect', function(e) {
            console.log('[EVENTO] select2:unselect disparado para:', $select.attr('id'));
            var $ivaInput = $('input[name="items-' + formIndex + '-porcentaje_iva"]');
            if ($ivaInput.length) {
                $ivaInput.val('0');
            }
        });
        
        // Si Select2 ya estÃ¡ inicializado (por base.html), destruirlo y reinicializarlo
        // para asegurar que funcione correctamente con nuestros eventos
        if (yaInicializado) {
            console.log('[initializeProductSelect2] Select2 ya inicializado por base.html, destruyendo y reinicializando');
            
            // Destruir Select2 existente
            try {
                $select.select2('destroy');
            } catch(e) {
                console.warn('[initializeProductSelect2] Error al destruir Select2:', e);
            }
            
            // Reinicializar Select2 con nuestra configuraciÃ³n
            $select.select2({
                dropdownParent: $('body'),
                width: '100%',
                placeholder: 'Selecciona un producto...',
                allowClear: true,
                language: {
                    noResults: function() {
                        return "No se encontraron resultados";
                    }
                }
            });
            
            // Establecer el valor despuÃ©s de reinicializar
            if (valorActual) {
                var $option = $select.find('option[value="' + valorActual + '"]');
                if ($option.length > 0) {
                    console.log('[initializeProductSelect2] Estableciendo valor despuÃ©s de reinicializar');
                    $select.val(valorActual).trigger('change.select2');
                    // Disparar evento change para que se ejecute calcularIVADelProducto
                    setTimeout(function() {
                        console.log('[initializeProductSelect2] Disparando evento change despuÃ©s de establecer valor');
                        $select.trigger('change');
                    }, 300);
                } else {
                    console.warn('[initializeProductSelect2] La opciÃ³n con valor', valorActual, 'no existe');
                }
            }
        } else {
            // Inicializar Select2 si no estÃ¡ inicializado
            console.log('[initializeProductSelect2] Inicializando Select2 para select ' + index);
            
            $select.select2({
                dropdownParent: $('body'),
                width: '100%',
                placeholder: 'Selecciona un producto...',
                allowClear: true, // Permitir limpiar la selecciÃ³n
                language: {
                    noResults: function() {
                        return "No se encontraron resultados";
                    }
                }
            });
            
            // Si hay un valor, asegurarnos de que Select2 lo muestre correctamente
            if (valorActual) {
                var $option = $select.find('option[value="' + valorActual + '"]');
                if ($option.length > 0) {
                    console.log('[initializeProductSelect2] Estableciendo valor despuÃ©s de inicializar');
                    $select.val(valorActual).trigger('change.select2');
                    // Disparar evento change para que se ejecute calcularIVADelProducto
                    // El evento change ya estÃ¡ configurado arriba, asÃ­ que solo necesitamos dispararlo
                    setTimeout(function() {
                        console.log('[initializeProductSelect2] Disparando evento change despuÃ©s de inicializar Select2');
                        $select.trigger('change');
                    }, 300);
                } else {
                    console.warn('[initializeProductSelect2] La opciÃ³n con valor', valorActual, 'no existe');
                }
            }
        }
        
        // Verificar el estado final y calcular IVA si hay un valor
        setTimeout(function() {
            var valorFinal = $select.val();
            var displayFinal = $select.next('.select2-container').find('.select2-selection__rendered').text();
            var textoOpcion = $select.find('option:selected').text();
            
            console.log('[initializeProductSelect2] Select ' + index + ' - ESTADO FINAL:');
            console.log('  - Valor:', valorFinal);
            console.log('  - Texto opciÃ³n:', textoOpcion);
            console.log('  - Display:', displayFinal);
            
            if (valorFinal && (displayFinal === '-- Selecciona un producto --' || displayFinal === '' || displayFinal.trim() === '')) {
                console.error('[initializeProductSelect2] âš ï¸ PROBLEMA: Display no muestra el valor correctamente');
                // Intentar mÃ©todo alternativo
                $select.val(valorFinal).trigger('change.select2');
            }
            
            // Si hay un valor final, asegurar que el IVA estÃ© calculado
            if (valorFinal) {
                console.log('[initializeProductSelect2] Disparando evento change en verificaciÃ³n final');
                // Disparar el evento change que ya tiene el handler configurado
                $select.trigger('change');
            } else {
                console.log('[initializeProductSelect2] No hay valor final, no se calcula IVA');
            }
        }, 500);
    });
    
    console.log('[initializeProductSelect2] FunciÃ³n completada');
}

function calcularIVADelProducto($selectProducto) {
    var selectId = $selectProducto.attr('id');
    var productoId = $selectProducto.val();
    
    console.log('[calcularIVADelProducto] ========== INICIANDO ==========');
    console.log('[calcularIVADelProducto] Select ID:', selectId);
    console.log('[calcularIVADelProducto] Producto ID:', productoId);
    
    if (!productoId || productoId === '' || productoId === null) {
        console.warn('[calcularIVADelProducto] âš ï¸ No hay producto ID, no se puede calcular IVA');
        return;
    }
    
    var filaActual = $selectProducto.closest('tr.row-principal');
    var formIndex = filaActual.data('form-index');
    console.log('[calcularIVADelProducto] Form index:', formIndex);
    
    // Buscar el campo IVA de mÃºltiples formas para asegurar que lo encontramos
    var $ivaInput = $('input[name="items-' + formIndex + '-porcentaje_iva"]');
    if (!$ivaInput.length) {
        // Intentar buscar por ID
        $ivaInput = $('#id_items-' + formIndex + '-porcentaje_iva');
    }
    if (!$ivaInput.length) {
        // Intentar buscar en la fila de precios
        var $rowPrecios = $('tr.row-precios[data-form-index="' + formIndex + '"]');
        $ivaInput = $rowPrecios.find('input[name$="-porcentaje_iva"]');
    }
    if (!$ivaInput.length) {
        // Intentar buscar por clase
        var $rowPrecios = $('tr.row-precios[data-form-index="' + formIndex + '"]');
        $ivaInput = $rowPrecios.find('.porcentaje-iva');
    }
    
    var $claveInput = filaActual.find('input[name$="-clave"]');
    
    console.log('[calcularIVADelProducto] Campo IVA encontrado:', $ivaInput.length > 0);
    if ($ivaInput.length > 0) {
        console.log('[calcularIVADelProducto] Campo IVA ID:', $ivaInput.attr('id'));
        console.log('[calcularIVADelProducto] Campo IVA name:', $ivaInput.attr('name'));
        console.log('[calcularIVADelProducto] Campo IVA valor actual:', $ivaInput.val());
    } else {
        console.error('[calcularIVADelProducto] âŒ No se encontrÃ³ el campo porcentaje_iva');
        console.error('[calcularIVADelProducto] Buscando todos los campos IVA disponibles...');
        $('input[name$="-porcentaje_iva"]').each(function() {
            console.log('[calcularIVADelProducto] Campo IVA encontrado:', $(this).attr('id'), $(this).attr('name'), 'form-index:', $(this).closest('tr').data('form-index'));
        });
        return;
    }
    
    console.log('[calcularIVADelProducto] Campo clave encontrado:', $claveInput.length > 0);
    
    var clave = '';
    var ivaProducto = null;
    
    // Usar el IVA del producto desde los datos cargados
    if (window.productosData && window.productosData[productoId]) {
        var productoData = window.productosData[productoId];
        ivaProducto = productoData.iva;
        clave = productoData.clave_cnis || '';
        
        console.log('[calcularIVADelProducto] Datos del producto encontrados:');
        console.log('[calcularIVADelProducto] - IVA del producto:', ivaProducto);
        console.log('[calcularIVADelProducto] - Clave CNIS:', clave);
        
        // Actualizar el campo clave con la clave del producto
        if ($claveInput.length && clave) {
            // Solo actualizar si estÃ¡ vacÃ­o, es DEFAULT, o no tiene valor vÃ¡lido
            var claveActual = $claveInput.val();
            if (!claveActual || claveActual === '' || claveActual === 'DEFAULT' || claveActual.toUpperCase() === 'DEFAULT') {
                $claveInput.val(clave);
                console.log('[calcularIVADelProducto] Clave actualizada con clave del producto:', clave);
            }
        }
        
        // IMPORTANTE: Calcular IVA basado en la CLAVE, no en el IVA del producto
        // Regla: Claves que inician con 010, 020, 030, 040 tienen IVA 0%
        // Todas las demÃ¡s tienen IVA 16%
        var ivaCalculado = 16; // Por defecto 16%
        if (clave && (clave.startsWith('010') || clave.startsWith('020') || clave.startsWith('030') || clave.startsWith('040'))) {
            ivaCalculado = 0;
        }
        
        console.log('[calcularIVADelProducto] ========== CALCULANDO IVA POR CLAVE ==========');
        console.log('[calcularIVADelProducto] Clave:', clave);
        console.log('[calcularIVADelProducto] IVA calculado por clave:', ivaCalculado, '%');
        console.log('[calcularIVADelProducto] (IVA del producto ignorado, se usa lÃ³gica de clave)');
        console.log('[calcularIVADelProducto] Valor ANTES de establecer:', $ivaInput.val());
        console.log('[calcularIVADelProducto] Campo IVA readonly:', $ivaInput.prop('readonly'));
        
        // Remover readonly temporalmente para poder establecer el valor
        var eraReadonly = $ivaInput.prop('readonly');
        if (eraReadonly) {
            $ivaInput.prop('readonly', false);
        }
        
        // Establecer el valor
        $ivaInput.val(ivaCalculado);
        
        // Restaurar readonly si estaba activo
        if (eraReadonly) {
            $ivaInput.prop('readonly', true);
        }
        
        // Forzar actualizaciÃ³n visual del campo usando mÃºltiples mÃ©todos
        $ivaInput.trigger('change');
        $ivaInput.trigger('input');
        $ivaInput.trigger('blur');
        
        // TambiÃ©n actualizar el atributo value directamente
        $ivaInput.attr('value', ivaCalculado);
        
        // Verificar que se estableciÃ³ correctamente
        setTimeout(function() {
            var valorDespues = $ivaInput.val();
            var valorAttr = $ivaInput.attr('value');
            console.log('[calcularIVADelProducto] Valor DESPUÃ‰S de establecer:');
            console.log('[calcularIVADelProducto] - .val():', valorDespues);
            console.log('[calcularIVADelProducto] - attr("value"):', valorAttr);
            
            if (valorDespues != ivaCalculado && valorAttr != ivaCalculado) {
                console.error('[calcularIVADelProducto] âš ï¸ PROBLEMA: El valor no se estableciÃ³ correctamente');
                console.error('[calcularIVADelProducto] Esperado:', ivaCalculado, 'Obtenido .val():', valorDespues, 'attr("value"):', valorAttr);
                
                // Intentar establecer nuevamente con mÃ©todo mÃ¡s directo
                $ivaInput.prop('readonly', false);
                $ivaInput[0].value = ivaCalculado;
                $ivaInput.prop('readonly', true);
                $ivaInput.trigger('change');
                
                setTimeout(function() {
                    var valorFinal = $ivaInput.val();
                    console.log('[calcularIVADelProducto] Valor despuÃ©s de mÃ©todo directo:', valorFinal);
                }, 50);
            } else {
                console.log('[calcularIVADelProducto] âœ… IVA establecido correctamente:', ivaCalculado, '% en campo:', $ivaInput.attr('id'));
            }
        }, 100);
    } else {
        // Fallback: usar la logica de clave si no tenemos los datos
        // Regla: Claves que inician con 010, 020, 030, 040 tienen IVA 0%
        // Todas las demÃ¡s tienen IVA 16%
        var selectedText = $selectProducto.find('option:selected').text();
        clave = extraerClaveDelProducto(selectedText);
        
        // Si no hay clave en el texto, intentar obtenerla del campo clave
        if (!clave && $claveInput.length && $claveInput.val() && $claveInput.val() !== 'DEFAULT') {
            clave = $claveInput.val();
        }
        
        // Si aÃºn no hay clave, usar la clave de la cita
        if (!clave && window.citaClaveDefault) {
            clave = window.citaClaveDefault;
            // Actualizar el campo clave
            if ($claveInput.length) {
                $claveInput.val(clave);
                console.log('[calcularIVADelProducto] Clave actualizada con clave de cita:', clave);
            }
        }
        
        var ivaCalculado = 16; // Por defecto 16%
        if (clave && (clave.startsWith('010') || clave.startsWith('020') || clave.startsWith('030') || clave.startsWith('040'))) {
            ivaCalculado = 0;
        }
        
        console.log('[calcularIVADelProducto] ========== CALCULANDO IVA POR CLAVE ==========');
        console.log('[calcularIVADelProducto] Clave:', clave);
        console.log('[calcularIVADelProducto] IVA calculado por clave:', ivaCalculado, '%');
        console.log('[calcularIVADelProducto] Valor ANTES de establecer:', $ivaInput.val());
        console.log('[calcularIVADelProducto] Campo IVA readonly:', $ivaInput.prop('readonly'));
        
        // Remover readonly temporalmente para poder establecer el valor
        var eraReadonly = $ivaInput.prop('readonly');
        if (eraReadonly) {
            $ivaInput.prop('readonly', false);
        }
        
        // Establecer el valor
        $ivaInput.val(ivaCalculado);
        
        // Restaurar readonly si estaba activo
        if (eraReadonly) {
            $ivaInput.prop('readonly', true);
        }
        
        // Forzar actualizaciÃ³n visual del campo usando mÃºltiples mÃ©todos
        $ivaInput.trigger('change');
        $ivaInput.trigger('input');
        $ivaInput.trigger('blur');
        
        // TambiÃ©n actualizar el atributo value directamente
        $ivaInput.attr('value', ivaCalculado);
        
        // Verificar que se estableciÃ³ correctamente
        setTimeout(function() {
            var valorDespues = $ivaInput.val();
            var valorAttr = $ivaInput.attr('value');
            console.log('[calcularIVADelProducto] Valor DESPUÃ‰S de establecer:');
            console.log('[calcularIVADelProducto] - .val():', valorDespues);
            console.log('[calcularIVADelProducto] - attr("value"):', valorAttr);
            
            if (valorDespues != ivaCalculado && valorAttr != ivaCalculado) {
                console.error('[calcularIVADelProducto] âš ï¸ PROBLEMA: El valor no se estableciÃ³ correctamente');
                console.error('[calcularIVADelProducto] Esperado:', ivaCalculado, 'Obtenido .val():', valorDespues, 'attr("value"):', valorAttr);
                
                // Intentar establecer nuevamente con mÃ©todo mÃ¡s directo
                $ivaInput.prop('readonly', false);
                $ivaInput[0].value = ivaCalculado;
                $ivaInput.prop('readonly', true);
                $ivaInput.trigger('change');
                
                setTimeout(function() {
                    var valorFinal = $ivaInput.val();
                    console.log('[calcularIVADelProducto] Valor despuÃ©s de mÃ©todo directo:', valorFinal);
                }, 50);
            } else {
                console.log('[calcularIVADelProducto] âœ… IVA establecido correctamente:', ivaCalculado, '% en campo:', $ivaInput.attr('id'));
            }
        }, 100);
    }
    
    // Asegurar que el campo tenga un valor (nunca estÃ© vacÃ­o)
    if (!$ivaInput.val() || $ivaInput.val() === '') {
        $ivaInput.val('0'); // Valor por defecto seguro
        $ivaInput.trigger('change');
    }
    
    // Verificar que el valor se estableciÃ³ correctamente
    setTimeout(function() {
        var valorFinalIVA = $ivaInput.val();
        console.log('[calcularIVADelProducto] ========== FINALIZANDO ==========');
        console.log('[calcularIVADelProducto] Valor final del IVA en el campo:', valorFinalIVA, 'Campo ID:', $ivaInput.attr('id'));
        console.log('[calcularIVADelProducto] Campo IVA visible:', $ivaInput.is(':visible'));
        console.log('[calcularIVADelProducto] Campo IVA disabled:', $ivaInput.is(':disabled'));
        console.log('[calcularIVADelProducto] Campo IVA readonly:', $ivaInput.prop('readonly'));
    }, 200);
    
    // Agregar eventos para calcular precios
    var $precioUnitario = $('input[name="items-' + formIndex + '-precio_unitario_sin_iva"]');
    $precioUnitario.off('change').on('change', function() {
        var row1 = $('tr.row-principal[data-form-index="' + formIndex + '"]');
        var row2 = $('tr.row-precios[data-form-index="' + formIndex + '"]');
        calculatePrices(row1, row2);
    });
    
    var $cantidadRecibida = $('input[name="items-' + formIndex + '-cantidad_recibida"]');
    $cantidadRecibida.off('change').on('change', function() {
        var row1 = $('tr.row-principal[data-form-index="' + formIndex + '"]');
        var row2 = $('tr.row-precios[data-form-index="' + formIndex + '"]');
        calculatePrices(row1, row2);
    });
}

function extraerClaveDelProducto(texto) {
    // Extrae los primeros 3 dÃ­gitos de la clave (formato: "Producto - 060.830.7070" o similar)
    var match = texto.match(/(\d{3})/);
    return match ? match[1] : null;
}

function addItemRow() {
    var formCount = $('#id_items-TOTAL_FORMS').val();
    var newFormIndex = parseInt(formCount);
    
    // FILA 1: Datos del Lote (orden: Producto, Lote, F. Caduc., F. de FabricaciÃ³n, Marca, Fabricante, Recibida)
    var newRow1 = $('<tr class="item-row row-principal" data-form-index="' + newFormIndex + '">' +
        '<td><small class="text-muted d-block mb-1">Producto</small><select id="id_items-' + newFormIndex + '-producto" name="items-' + newFormIndex + '-producto" class="form-control select2-single" data-placeholder="-- Selecciona un producto --"></select></td>' +
        '<td><small class="text-muted d-block mb-1">Lote</small><input type="text" id="id_items-' + newFormIndex + '-numero_lote" name="items-' + newFormIndex + '-numero_lote" class="form-control numero-lote"></td>' +
        '<td><small class="text-muted d-block mb-1">F. Caduc.</small><input type="date" id="id_items-' + newFormIndex + '-fecha_caducidad" name="items-' + newFormIndex + '-fecha_caducidad" class="form-control"></td>' +
        '<td><small class="text-muted d-block mb-1">F. de FabricaciÃ³n</small><input type="date" id="id_items-' + newFormIndex + '-fecha_elaboracion" name="items-' + newFormIndex + '-fecha_elaboracion" class="form-control"></td>' +
        '<td><small class="text-muted d-block mb-1">Marca</small><input type="text" id="id_items-' + newFormIndex + '-marca" name="items-' + newFormIndex + '-marca" class="form-control"></td>' +
        '<td><small class="text-muted d-block mb-1">Fabricante</small><input type="text" id="id_items-' + newFormIndex + '-fabricante" name="items-' + newFormIndex + '-fabricante" class="form-control"></td>' +
        '<td><small class="text-muted d-block mb-1">Recibida</small><input type="number" id="id_items-' + newFormIndex + '-cantidad_recibida" name="items-' + newFormIndex + '-cantidad_recibida" class="form-control cantidad-recibida"></td>' +
        '<td style="display: none;"><input type="text" id="id_items-' + newFormIndex + '-clave" name="items-' + newFormIndex + '-clave" class="form-control"></td>' +
        '<td style="display: none;"><small class="text-muted d-block mb-1">Emitida</small><input type="number" id="id_items-' + newFormIndex + '-cantidad_emitida" name="items-' + newFormIndex + '-cantidad_emitida" class="form-control cantidad-emitida"></td>' +
        '<td style="display: none;"><small class="text-muted d-block mb-1">Piezas/Lote</small><input type="number" id="id_items-' + newFormIndex + '-piezas_por_lote" name="items-' + newFormIndex + '-piezas_por_lote" class="form-control piezas-por-lote" min="1" value="1"></td>' +
        '<td><button type="button" class="btn-remove-item" onclick="removeRow(this)">Eliminar</button></td>' +
        '</tr>');
    
    // FILA 2: Precios e IVA
    // Obtener el precio del item anterior si existe
    var precioAnterior = '';
    var ultimoRow2 = $('#items-tbody tr.row-precios').last();
    if (ultimoRow2.length > 0) {
        precioAnterior = ultimoRow2.find('.precio-unitario').val();
    }
    
    var newRow2 = $('<tr class="item-row row-precios" data-form-index="' + newFormIndex + '">' +
        '<td><small class="text-muted d-block mb-1">P. Unitario</small><input type="number" id="id_items-' + newFormIndex + '-precio_unitario_sin_iva" name="items-' + newFormIndex + '-precio_unitario_sin_iva" class="form-control precio-unitario" step="0.01" placeholder="0.00" value="' + precioAnterior + '"></td>' +
        '<td><small class="text-muted d-block mb-1">% IVA</small><input type="number" id="id_items-' + newFormIndex + '-porcentaje_iva" name="items-' + newFormIndex + '-porcentaje_iva" class="form-control porcentaje-iva" step="0.01" placeholder="0.00" readonly></td>' +
        '<td><small class="text-muted d-block mb-1">P. con IVA</small><input type="number" id="id_items-' + newFormIndex + '-precio_unitario_con_iva" name="items-' + newFormIndex + '-precio_unitario_con_iva" class="form-control precio-con-iva" step="0.01" placeholder="0.00" readonly></td>' +
        '<td><small class="text-muted d-block mb-1">Subtotal</small><input type="number" id="id_items-' + newFormIndex + '-subtotal" name="items-' + newFormIndex + '-subtotal" class="form-control subtotal" step="0.01" placeholder="0.00" readonly></td>' +
        '<td><small class="text-muted d-block mb-1">Importe IVA</small><input type="number" id="id_items-' + newFormIndex + '-importe_iva" name="items-' + newFormIndex + '-importe_iva" class="form-control importe-iva" step="0.01" placeholder="0.00" readonly></td>' +
        '<td><small class="text-muted d-block mb-1">Importe Total</small><input type="number" id="id_items-' + newFormIndex + '-importe_total" name="items-' + newFormIndex + '-importe_total" class="form-control importe-total" step="0.01" placeholder="0.00" readonly></td>' +
        '<td colspan="2"></td>' +
        '</tr>');
    
    $('#items-tbody').append(newRow1);
    $('#items-tbody').append(newRow2);
    
    $('#id_items-TOTAL_FORMS').val(newFormIndex + 1);
    
    // Cargar opciones de productos
    var newSelect = newRow1.find('select[id$="-producto"]');
    $.ajax({
        url: '/logistica/llegadas/api/productos/',
        type: 'GET',
        success: function(data) {
            // Guardar los datos de productos para acceso posterior
            if (!window.productosData) {
                window.productosData = {};
            }
            
            $.each(data, function(index, producto) {
                newSelect.append('<option value="' + producto.id + '">' + producto.descripcion + '</option>');
                window.productosData[producto.id] = producto;
            });
            
            // Inicializar Select2 DESPUES de cargar opciones
            newSelect.select2({
                dropdownParent: $('body'),
                width: '100%',
                placeholder: 'Selecciona un producto...'
            });
            
            // Agregar eventos para calcular IVA
            newSelect.on('select2:select', function() {
                calcularIVADelProducto($(this));
            });
            newSelect.on('change', function() {
                calcularIVADelProducto($(this));
            });
            
            // Pre-seleccionar producto si hay clave de medicamento
            if (window.citaClaveDefault) {
                // Buscar por clave_cnis en los datos originales
                var productoEncontrado = null;
                $.each(data, function(index, producto) {
                    if (producto.clave_cnis === window.citaClaveDefault) {
                        productoEncontrado = producto.id;
                        return false; // break
                    }
                });
                if (productoEncontrado) {
                    newSelect.val(productoEncontrado).trigger('change');
                } else {
                    // Si no se encuentra el producto, al menos establecer la clave en el campo
                    var formIndex = newRow1.data('form-index');
                    var $claveField = newRow1.find('input[name="items-' + formIndex + '-clave"]');
                    if ($claveField.length && window.citaClaveDefault) {
                        $claveField.val(window.citaClaveDefault);
                        console.log('[addItemRow] Clave establecida en nuevo item:', window.citaClaveDefault);
                    }
                }
                
                // Establecer la clave si estÃ¡ disponible
                if (window.citaClaveDefault) {
                    var formIndex = newRow1.data('form-index');
                    var $claveField = newRow1.find('input[name="items-' + formIndex + '-clave"]');
                    if ($claveField.length && !$claveField.val()) {
                        $claveField.val(window.citaClaveDefault);
                        console.log('[addItemRow] Clave establecida desde cita:', window.citaClaveDefault);
                    }
                }
            }
        },
        error: function() {
            console.log('Error al cargar productos');
        }
    });
    
    // Agregar validaciones
    addFieldValidation(newRow1, newRow2);
    
    // Llenar campos por defecto
    fillDefaultFieldValues();
}

function fillDefaultFieldValues() {
    // Obtener la clave de la cita si estÃ¡ disponible
    var claveCita = window.citaClaveDefault || $('#clave-producto-ref').text().trim();
    if (claveCita === '-' || claveCita === '') {
        claveCita = null;
    }
    
    console.log('[fillDefaultFieldValues] Iniciando. Clave de cita disponible:', claveCita);
    console.log('[fillDefaultFieldValues] Total items encontrados:', $('#items-tbody tr.row-principal').length);
    
    // Llenar campos por defecto para todos los items
    $('#items-tbody tr.row-principal').each(function() {
        var $row = $(this);
        var formIndex = $row.data('form-index');
        
        // Llenar clave con la clave de la cita si estÃ¡ vacÃ­o o es DEFAULT
        var $claveField = $row.find('input[name="items-' + formIndex + '-clave"]');
        if ($claveField.length) {
            var claveActual = $claveField.val();
            // Si estÃ¡ vacÃ­o, es DEFAULT, o no tiene valor vÃ¡lido, usar la clave de la cita
            if (!claveActual || claveActual === '' || claveActual === 'DEFAULT' || claveActual.toUpperCase() === 'DEFAULT') {
                if (claveCita) {
                    $claveField.val(claveCita);
                    console.log('[fillDefaultFieldValues] Item ' + formIndex + ': Clave actualizada con clave de cita:', claveCita, '(era:', claveActual + ')');
                } else {
                    // Si no hay clave de cita, intentar obtenerla del producto seleccionado
                    var $productoSelect = $row.find('select[name="items-' + formIndex + '-producto"]');
                    if ($productoSelect.length && $productoSelect.val()) {
                        var productoId = $productoSelect.val();
                        if (window.productosData && window.productosData[productoId]) {
                            var claveProducto = window.productosData[productoId].clave_cnis;
                            if (claveProducto) {
                                $claveField.val(claveProducto);
                                console.log('[fillDefaultFieldValues] Item ' + formIndex + ': Clave actualizada con clave del producto:', claveProducto);
                            }
                        }
                    } else {
                        console.log('[fillDefaultFieldValues] Item ' + formIndex + ': No se pudo actualizar clave (sin cita ni producto)');
                    }
                }
            } else {
                console.log('[fillDefaultFieldValues] Item ' + formIndex + ': Clave ya tiene valor vÃ¡lido:', claveActual);
            }
        } else {
            console.warn('[fillDefaultFieldValues] Item ' + formIndex + ': No se encontrÃ³ el campo clave');
        }
        
        // Llenar cantidad_emitida con la cantidad_recibida si estÃ¡ vacÃ­o
        var $cantidadEmitidaField = $row.find('input[name="items-' + formIndex + '-cantidad_emitida"]');
        var $cantidadRecibidaField = $row.find('input[name="items-' + formIndex + '-cantidad_recibida"]');
        if ($cantidadEmitidaField.length && !$cantidadEmitidaField.val()) {
            var cantidadRecibida = $cantidadRecibidaField.val() || '1';
            $cantidadEmitidaField.val(cantidadRecibida);
        }
    });
    
    console.log('[fillDefaultFieldValues] Finalizado');
}

function removeRow(btn) {
    var row = $(btn).closest('tr');
    var formIndex = row.data('form-index');
    
    // Eliminar ambas filas (principal y precios)
    $('#items-tbody tr[data-form-index="' + formIndex + '"]').remove();
    updateFormCount();
}

function updateFormCount() {
    var count = $('#items-tbody tr.row-principal').length;
    $('#id_items-TOTAL_FORMS').val(count);
}

function addFieldValidation(row1, row2) {
    var formIndex = row1.data('form-index');
    var row2Actual = $('tr.row-precios[data-form-index="' + formIndex + '"]');
    // Validar cantidad_recibida <= cantidad_emitida
    row1.find('.cantidad-recibida').on('change', function() {
        var cantEmitida = row1.find('input[name$="-cantidad_emitida"]').val();
        var cantRecibida = $(this).val();
        if (parseInt(cantRecibida) > parseInt(cantEmitida)) {
            $(this).css('border-color', 'red');
        } else {
            $(this).css('border-color', '');
        }
    });
    
    // Calcular IVA automÃ¡tico segÃºn clave
    // Regla: Claves que inician con 010, 020, 030, 040 tienen IVA 0%
    // Todas las demÃ¡s tienen IVA 16%
    row1.find('.clave-cnis').on('change', function() {
        var clave = $(this).val();
        var ivaField = row2Actual.find('.porcentaje-iva');
        
        if (clave && (clave.startsWith('010') || clave.startsWith('020') || clave.startsWith('030') || clave.startsWith('040'))) {
            ivaField.val('0');
        } else {
            ivaField.val('16');
        }
        
        calculatePrices(row1, row2);
    });
    
    // Calcular precios cuando cambia precio unitario
    row2Actual.find('.precio-unitario').on('change', function() {
        calculatePrices(row1, row2Actual);
    });
    
    // Calcular precios cuando cambia cantidad recibida
    row1.find('.cantidad-recibida').on('change', function() {
        calculatePrices(row1, row2Actual);
        updateTotalPiezasRecibidas();
    });
}

function fillPreciosFromPreviousItem() {
    var precioAnterior = '';
    $('#items-tbody tr.row-precios').each(function(index) {
        var $precioActual = $(this).find('.precio-unitario');
        
        if (index > 0 && precioAnterior) {
            if (!$precioActual.val()) {
                $precioActual.val(precioAnterior);
                console.log('Precio del item ' + index + ' llenado con:', precioAnterior);
            }
        }
        
        precioAnterior = $precioActual.val();
    });
}

function updateTotalPiezasRecibidas() {
    var total = 0;
    $('#items-tbody tr.row-principal').each(function() {
        var cantidad = parseInt($(this).find('input[name$="-cantidad_recibida"]').val()) || 0;
        total += cantidad;
    });
    // Actualizar el campo del formulario Django
    $('#id_numero_piezas_recibidas').val(total);
}

function calculatePrices(row1, row2) {
    var precioUnitario = parseFloat(row2.find('.precio-unitario').val()) || 0;
    var porcentajeIva = parseFloat(row2.find('.porcentaje-iva').val()) || 0;
    var cantRecibida = parseInt(row1.find('.cantidad-recibida').val()) || 0;
    
    // Calcular precio con IVA (porcentajeIva ya estÃ¡ en formato 0.16 o 0.00)
    var precioConIva = precioUnitario * (1 + porcentajeIva);
    
    // Calcular subtotal (precio unitario * cantidad)
    var subtotal = precioUnitario * cantRecibida;
    
    // Calcular importe IVA (porcentajeIva ya estÃ¡ en formato 0.16 o 0.00)
    var importeIva = subtotal * porcentajeIva;
    
    // Calcular importe total
    var importeTotal = subtotal + importeIva;
    
    row2.find('.precio-con-iva').val(precioConIva.toFixed(2));
    row2.find('.subtotal').val(subtotal.toFixed(2));
    row2.find('.importe-iva').val(importeIva.toFixed(2));
    row2.find('.importe-total').val(importeTotal.toFixed(2));
}

function validatePiezasSum() {
    // Validar que al menos haya un item con cantidad recibida
    var hasItems = false;
    $('#items-tbody tr.row-principal').each(function() {
        var cantRecibida = parseInt($(this).find('input[name$="-cantidad_recibida"]').val()) || 0;
        if (cantRecibida > 0) {
            hasItems = true;
        }
    });
    
    if (!hasItems) {
        showValidationMessage('Debe haber al menos un item con cantidad recibida mayor a 0.');
        return false;
    }
    
    return true;
}

function showValidationMessage(message) {
    var msgDiv = $('#validation-message');
    msgDiv.html(message);
    msgDiv.show();
    $('html, body').animate({scrollTop: msgDiv.offset().top - 100}, 'slow');
}
</script>
{% endblock %}
{% endblock %}

