{% extends "base.html" %}
{% load static %}

{% block title %}Asignar Ubicaci√≥n{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-12">
            <h2>Asignar Ubicaci√≥n - {{ llegada.folio }}</h2>
            <p class="text-muted">Asigna la ubicaci√≥n f√≠sica para cada lote recibido. Puedes distribuir un lote en m√∫ltiples ubicaciones.</p>
            
            <form id="ubicacion-form" method="post">
                {% csrf_token %}
                
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Asignar Ubicaci√≥n a Lotes</h5>
                    </div>
                    <div class="card-body">
                        {% for item in items_with_ubicaciones %}
                        <div class="card mb-4" data-item-index="{{ forloop.counter0 }}">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">{{ item.producto.descripcion }}</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">
                                    <strong>Lote:</strong> {{ item.lote.codigo }} | 
                                    <strong>Cantidad Recibida:</strong> <span class="badge badge-info">{{ item.cantidad_recibida }}</span> unidades | 
                                    <strong>Caducidad:</strong> {{ item.lote.fecha_caducidad|date:"d/m/Y" }}
                                </p>
                                
                                <div class="form-group">
                                    <label><strong>Almac√©n</strong></label>
                                    {% if item.ubicaciones_asignadas %}
                                        {% with almacen_id=item.ubicaciones_asignadas.0.ubicacion__almacen_id %}
                                        <select name="ubicacion-detalle-{{ forloop.counter0 }}-0-almacen" class="form-control select2-single" required data-selected="{{ almacen_id }}">
                                            <option value="">-- Selecciona un almac√©n --</option>
                                            {% for almacen in almacenes %}
                                            <option value="{{ almacen.id }}" {% if almacen.id == almacen_id %}selected{% endif %}>Almac√©n {{ almacen.nombre }} ({{ almacen.codigo }})</option>
                                            {% endfor %}
                                        </select>
                                        {% endwith %}
                                    {% else %}
                                    <select name="ubicacion-detalle-{{ forloop.counter0 }}-0-almacen" class="form-control select2-single" required>
                                        <option value="">-- Selecciona un almac√©n --</option>
                                        {% for almacen in almacenes %}
                                        <option value="{{ almacen.id }}">Almac√©n {{ almacen.nombre }} ({{ almacen.codigo }})</option>
                                        {% endfor %}
                                    </select>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <label><strong>Ubicaciones (Puedes asignar a m√∫ltiples ubicaciones)</strong></label>
                                    <div class="ubicaciones-container" data-item-index="{{ forloop.counter0 }}" data-item-ubicaciones='{{ item.ubicaciones_asignadas_json }}'>
                                        <!-- Las ubicaciones se cargar√°n din√°micamente con JavaScript -->
                                    </div>
                                    <button type="button" class="btn btn-sm btn-success add-ubicacion" data-item-index="{{ forloop.counter0 }}" style="display:none;">
                                        <i class="fas fa-plus"></i> Agregar otra ubicaci√≥n
                                    </button>
                                </div>
                                
                                <div class="alert alert-info mt-3">
                                    <strong>Cantidad Total Recibida:</strong> {{ item.cantidad_recibida }} unidades<br>
                                    <strong>Cantidad Asignada:</strong> <span class="cantidad-asignada" data-item-index="{{ forloop.counter0 }}">{{ item.cantidad_recibida }}</span> unidades
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Guardar Ubicaciones</button>
                    <a href="{% url 'logistica:llegadas:detalle_llegada' llegada.pk %}" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // ===== DEFINICI√ìN DE FUNCIONES (ANTES del DOMContentLoaded) =====
    
    function setupAlmacenChangeHandlers() {
        console.log('‚öôÔ∏è Configurando handlers para cambio de almac√©n...');
        
        // Encontrar todos los selects de almac√©n
        $(document).on('change.select2', 'select[name*="almacen"]', function() {
            const almacenId = this.value;
            console.log('Almac√©n seleccionado: ' + almacenId);
            
            if (!almacenId) {
                console.log('No se seleccion√≥ almac√©n');
                return;
            }
            
            // Obtener el √≠ndice del item
            const itemIndex = $(this).closest('[data-item-index]').data('itemIndex');
            console.log('Item index: ' + itemIndex);
            
            // Cargar ubicaciones para este almac√©n
            fetch('/logistica/llegadas/api/ubicaciones-por-almacen/?almacen_id=' + almacenId)
                .then(response => response.json())
                .then(data => {
                    console.log('Ubicaciones cargadas:', data);
                    updateUbicacionesSelect(itemIndex, data.ubicaciones);
                })
                .catch(error => {
                    console.error('Error al cargar ubicaciones:', error);
                });
        });
    }
    
    function updateUbicacionesSelect(itemIndex, ubicaciones) {
        console.log(`üîÑ Actualizando ubicaciones para item ${itemIndex}`);
        
        // Encontrar el select de ubicaci√≥n para este item
        const container = document.querySelector(`[data-item-index="${itemIndex}"]`);
        if (!container) {
            console.error(`‚ùå No se encontr√≥ contenedor para item ${itemIndex}`);
            return;
        }
        
        // Encontrar todos los selects de ubicaci√≥n en este contenedor (usar clase, no nombre)
        const ubicacionSelects = container.querySelectorAll('select.ubicacion-select');
        console.log(`üìä Se encontraron ${ubicacionSelects.length} selects de ubicaci√≥n`);
        
        ubicacionSelects.forEach((select) => {
            // Guardar el valor actual o el valor guardado en data-ubicacion-id
            const currentValue = select.value || select.dataset.ubicacionId;
            
            // Limpiar opciones excepto la primera (vac√≠a)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Agregar nuevas opciones
            ubicaciones.forEach((ubicacion) => {
                const option = document.createElement('option');
                option.value = ubicacion.id;
                option.textContent = `${ubicacion.codigo} - ${ubicacion.descripcion}`;
                select.appendChild(option);
            });
            
            // Restaurar el valor si existe en las nuevas opciones
            if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                select.value = currentValue;
                console.log('Establecido valor ' + currentValue + ' en select');
            }
            
            // Disparar evento change para que Select2 se actualice
            $(select).trigger('change');
        });
    }
    
    function initializeSelect2() {
        console.log('üîç Inicializando Select2...');
        const selects = document.querySelectorAll('.select2-single');
        console.log(`üìä Se encontraron ${selects.length} selects para inicializar`);
        
        selects.forEach((select, idx) => {
            console.log(`üìå Select ${idx}:`, select);
            console.log(`   - Nombre: ${select.name}`);
            console.log(`   - Opciones: ${select.options.length}`);
        });
        
        $('.select2-single').select2({
            allowClear: true,
            placeholder: 'Selecciona una opci√≥n',
            width: '100%'
        });
        
        // Cargar ubicaciones para los almacenes previamente seleccionados
        document.querySelectorAll('select[name*="almacen"]').forEach((select) => {
            const almacenId = select.value;
            if (almacenId) {
                const itemIndex = $(select).closest('[data-item-index]').data('itemIndex');
                console.log(`Cargando ubicaciones para almacen ${almacenId}, item ${itemIndex}`);
                fetch('/logistica/llegadas/api/ubicaciones-por-almacen/?almacen_id=' + almacenId)
                    .then(response => response.json())
                    .then(data => {
                        updateUbicacionesSelect(itemIndex, data.ubicaciones);
                        // Establecer los valores previamente guardados
                        const container = document.querySelector(`[data-item-index="${itemIndex}"]`);
                        container.querySelectorAll('.ubicacion-row').forEach((row) => {
                            const ubicacionId = row.dataset.ubicacionId;
                            if (ubicacionId) {
                                const select = row.querySelector('select.ubicacion-select');
                                if (select) {
                                    select.value = ubicacionId;
                                    $(select).trigger('change');
                                    console.log(`Estableciendo ubicacion ${ubicacionId} en select`);
                                }
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error al cargar ubicaciones:', error);
                    });
            }
        });
        
        console.log('‚úÖ Select2 inicializado');
    }
    
    function addUbicacion(button) {
        const itemIndex = button.dataset.itemIndex;
        const container = document.querySelector(`[data-item-index="${itemIndex}"]`);
        const rowCount = container.querySelectorAll('.ubicacion-row').length;
        
        // Obtener el almac√©n actualmente seleccionado
        const almacenSelect = container.querySelector('select[name*="almacen"]');
        const almacenId = almacenSelect ? almacenSelect.value : null;
        
        const newRow = document.createElement('div');
        newRow.className = 'ubicacion-row mb-3 p-3 border rounded';
        newRow.style.backgroundColor = '#f8f9fa';
        newRow.innerHTML = `
            <div class="row">
                <div class="col-md-8">
                    <label>Ubicaci√≥n</label>
                    <select name="ubicacion-detalle-${itemIndex}-${rowCount}-ubicacion" class="form-control select2-single ubicacion-select" required>
                        <option value="">-- Selecciona una ubicaci√≥n --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Cantidad</label>
                    <input type="number" name="ubicacion-detalle-${itemIndex}-${rowCount}-cantidad" class="form-control cantidad-input" value="0" min="0" required>
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-sm btn-danger remove-ubicacion" data-item-index="${itemIndex}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.querySelector('.ubicaciones-container').appendChild(newRow);
        
        // Inicializar Select2 en el nuevo select
        $(newRow).find('.select2-single').select2({
            allowClear: true,
            placeholder: 'Selecciona una opci√≥n',
            width: '100%'
        });
        
        // Si hay un almac√©n seleccionado, cargar sus ubicaciones
        if (almacenId) {
            const ubicacionSelect = newRow.querySelector('select.ubicacion-select');
            fetch('/logistica/llegadas/api/ubicaciones-por-almacen/?almacen_id=' + almacenId)
                .then(response => response.json())
                .then(data => {
                    // Limpiar opciones excepto la primera (vac√≠a)
                    while (ubicacionSelect.options.length > 1) {
                        ubicacionSelect.remove(1);
                    }
                    
                    // Agregar nuevas opciones
                    data.ubicaciones.forEach((ubicacion) => {
                        const option = document.createElement('option');
                        option.value = ubicacion.id;
                        option.textContent = `${ubicacion.codigo} - ${ubicacion.descripcion}`;
                        ubicacionSelect.appendChild(option);
                    });
                    
                    // Actualizar Select2
                    $(ubicacionSelect).trigger('change');
                })
                .catch(error => {
                    console.error('Error al cargar ubicaciones:', error);
                });
        }
        
        updateCantidadesTotales();
    }
    
    function removeUbicacion(button) {
        const itemIndex = button.dataset.itemIndex;
        button.closest('.ubicacion-row').remove();
        updateCantidadesTotales();
    }
    
    function crearFilasUbicacionesGuardadas() {
        console.log('Creando filas de ubicaciones guardadas...');
        document.querySelectorAll('.ubicaciones-container').forEach((container) => {
            const itemIndex = container.dataset.itemIndex;
            const ubicacionesJson = container.dataset.itemUbicaciones;
            
            if (ubicacionesJson && ubicacionesJson !== '[]') {
                try {
                    const ubicaciones = JSON.parse(ubicacionesJson);
                    console.log('Item ' + itemIndex + ': ' + ubicaciones.length + ' ubicaciones guardadas');
                    
                    ubicaciones.forEach((ubi, idx) => {
                        const newRow = document.createElement('div');
                        newRow.className = 'ubicacion-row mb-3 p-3 border rounded';
                        newRow.style.backgroundColor = '#f8f9fa';
                        newRow.innerHTML = '<div class="row"><div class="col-md-8"><label>Ubicacion</label><select name="ubicacion-detalle-' + itemIndex + '-' + idx + '-ubicacion" class="form-control select2-single ubicacion-select" required data-ubicacion-id="' + ubi.ubicacion_id + '"><option value="">-- Selecciona una ubicacion --</option></select></div><div class="col-md-3"><label>Cantidad</label><input type="number" name="ubicacion-detalle-' + itemIndex + '-' + idx + '-cantidad" class="form-control cantidad-input" value="' + ubi.cantidad + '" min="1" required></div><div class="col-md-1 d-flex align-items-end"><button type="button" class="btn btn-sm btn-danger remove-ubicacion" data-item-index="' + itemIndex + '"><i class="fas fa-trash"></i></button></div></div>';
                        container.appendChild(newRow);
                    });
                } catch (e) {
                    console.error('Error al parsear ubicaciones:', e);
                }
            } else {
                const newRow = document.createElement('div');
                newRow.className = 'ubicacion-row mb-3 p-3 border rounded';
                newRow.style.backgroundColor = '#f8f9fa';
                newRow.innerHTML = '<div class="row"><div class="col-md-8"><label>Ubicacion</label><select name="ubicacion-detalle-' + itemIndex + '-0-ubicacion" class="form-control select2-single ubicacion-select" required><option value="">-- Selecciona una ubicacion --</option></select></div><div class="col-md-4"><label>Cantidad</label><input type="number" name="ubicacion-detalle-' + itemIndex + '-0-cantidad" class="form-control cantidad-input" value="0" min="0" required></div></div>';
                container.appendChild(newRow);
            }
        });
    }
    
    function updateCantidadesTotales() {
        console.log('üìä Actualizando cantidades totales...');
        
        document.querySelectorAll('[data-item-index]').forEach((container) => {
            const itemIndex = container.dataset.itemIndex;
            const cantidadInputs = container.querySelectorAll('.cantidad-input');
            let total = 0;
            
            cantidadInputs.forEach((input) => {
                const value = parseInt(input.value) || 0;
                total += value;
            });
            
            const cantidadAsignada = container.querySelector(`.cantidad-asignada[data-item-index="${itemIndex}"]`);
            if (cantidadAsignada) {
                cantidadAsignada.textContent = total;
            }
        });
    }
    
    function validarCantidades() {
        console.log('‚úîÔ∏è Validando cantidades...');
        let isValid = true;
        
        document.querySelectorAll('[data-item-index]').forEach((container) => {
            const itemIndex = container.dataset.itemIndex;
            const cantidadRecibidaText = container.querySelector('.alert-info').textContent;
            const match = cantidadRecibidaText.match(/Cantidad Total Recibida:\s*(\d+)/);
            const cantidadRecibida = match ? parseInt(match[1]) : 0;
            
            const cantidadAsignada = container.querySelector(`.cantidad-asignada[data-item-index="${itemIndex}"]`);
            const asignada = parseInt(cantidadAsignada.textContent) || 0;
            
            if (asignada !== cantidadRecibida) {
                console.warn(`‚ùå Item ${itemIndex}: Recibida ${cantidadRecibida}, Asignada ${asignada}`);
                isValid = false;
            }
        });
        
        return isValid;
    }
    
    // ===== DOMContentLoaded (DESPU√âS de definir funciones) =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ DOM Cargado - Iniciando funciones...');
        console.log('üìã items_with_ubicaciones:', document.querySelectorAll('[data-item-index]').length);
        
        crearFilasUbicacionesGuardadas();
        initializeSelect2();
        updateCantidadesTotales();
        setupAlmacenChangeHandlers();
        
        document.addEventListener('click', function(e) {
            if (e.target.closest('.add-ubicacion')) {
                e.preventDefault();
                addUbicacion(e.target.closest('.add-ubicacion'));
            }
            if (e.target.closest('.remove-ubicacion')) {
                e.preventDefault();
                removeUbicacion(e.target.closest('.remove-ubicacion'));
            }
        });
        
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('cantidad-input')) {
                updateCantidadesTotales();
            }
        });
        
        document.getElementById('ubicacion-form').addEventListener('submit', function(e) {
            if (!validarCantidades()) {
                e.preventDefault();
                alert('Por favor, verifica que las cantidades sean correctas.');
            }
        });
    });
</script>

<style>
    .ubicacion-row {
        transition: all 0.3s ease;
    }
    
    .ubicacion-row:hover {
        background-color: #e8f4f8 !important;
    }
    
    .select2-container {
        width: 100% !important;
    }
</style>
{% endblock %}
