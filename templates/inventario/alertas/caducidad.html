{% extends 'base.html' %}
{% load humanize %}
{% load custom_filters %}
{% block title %}Alertas de Caducidad - Sistema de Inventario Hospitalario{% endblock %}

{% block page_title %}Alertas de Caducidad{% endblock %}

{% block page_actions %}
<a href="{% url 'reporte_caducidades_excel' %}" class="btn btn-success">
    <i class="fas fa-file-excel"></i> Exportar Excel
</a>
{% endblock %}

{% block content %}
<!-- Resumen de alertas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <h3 class="text-danger">{{ stats.caducados }}</h3>
                <p class="mb-0">Productos Caducados</p>
                <small class="text-muted">Requieren acción inmediata</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ stats.proximos_30 }}</h3>
                <p class="mb-0">Próximos 30 días</p>
                <small class="text-muted">Prioridad alta</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <h3 class="text-info">{{ stats.proximos_60 }}</h3>
                <p class="mb-0">Próximos 60 días</p>
                <small class="text-muted">Prioridad media</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-secondary">
            <div class="card-body text-center">
                <h3 class="text-secondary">{{ stats.proximos_90 }}</h3>
                <p class="mb-0">Próximos 90 días</p>
                <small class="text-muted">Prioridad baja</small>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="prioridad" class="form-label">Prioridad</label>
                <select class="form-select" id="prioridad" name="prioridad">
                    <option value="">Todas las prioridades</option>
                    <option value="critica" {% if prioridad_selected == "critica" %}selected{% endif %}>Crítica (Caducados)</option>
                    <option value="alta" {% if prioridad_selected == "alta" %}selected{% endif %}>Alta (30 días)</option>
                    <option value="media" {% if prioridad_selected == "media" %}selected{% endif %}>Media (60 días)</option>
                    <option value="baja" {% if prioridad_selected == "baja" %}selected{% endif %}>Baja (90 días)</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="institucion" class="form-label">Institución</label>
                <select class="form-select" id="institucion" name="institucion">
                    <option value="">Todas las instituciones</option>
                    {% for institucion in instituciones %}
                    <option value="{{ institucion.id }}" {% if institucion.id|stringformat:"s" == institucion_selected %}selected{% endif %}>
                        {{ institucion.clue }} - {{ institucion.denominacion|truncatechars:30 }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="search" class="form-label">Buscar Producto</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search }}" placeholder="Clave CNIS o descripción">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Lista de alertas -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-exclamation-triangle"></i> 
            Alertas de Caducidad ({{ page_obj.paginator.count }} total)
        </h5>
    </div>
    <div class="card-body p-0">
        {% if page_obj %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Prioridad</th>
                        <th>Producto</th>
                        <th>Lote</th>
                        <th>Institución</th>
                        <th>Cantidad</th>
                        <th>Valor</th>
                        <th>Fecha Caducidad</th>
                        <th>Días Restantes</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lote in page_obj %}
                    {% with dias=lote.dias_para_caducidad %}
                    <tr class="{% if dias < 0 %}table-danger{% elif dias <= 30 %}table-warning{% elif dias <= 60 %}table-info{% endif %}">
                        <td>
                            {% if dias < 0 %}
                                <span class="badge bg-danger">CRÍTICA</span>
                            {% elif dias <= 30 %}
                                <span class="badge bg-warning">ALTA</span>
                            {% elif dias <= 60 %}
                                <span class="badge bg-info">MEDIA</span>
                            {% else %}
                                <span class="badge bg-secondary">BAJA</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <strong>{{ lote.producto.clave_cnis }}</strong>
                                <br>
                                <small class="text-muted">{{ lote.producto.descripcion|truncatechars:40 }}</small>
                            </div>
                        </td>
                        <td>
                            <strong>{{ lote.numero_lote }}</strong>
                        </td>
                        <td>
                            <div>
                                <strong>{{ lote.institucion.clue }}</strong>
                                <br>
                                <small class="text-muted">{{ lote.institucion.denominacion|truncatechars:25 }}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-{% if lote.cantidad_disponible > 50 %}success{% elif lote.cantidad_disponible > 10 %}warning{% else %}danger{% endif %}">
                                {{ lote.cantidad_disponible|intcomma }}
                            </span>
                        </td>
                        <td>
                            <strong>${{ lote.valor_total|floatformat:2|intcomma }}</strong>
                        </td>
                        <td>
                            {{ lote.fecha_caducidad|date:"d/m/Y" }}
                        </td>
                        <td>
                            {% if dias < 0 %}
                                <span class="text-danger fw-bold">{{ dias|add:0|stringformat:"d"|slice:"1:" }} días vencido</span>
                            {% elif dias == 0 %}
                                <span class="text-danger fw-bold">Vence hoy</span>
                            {% else %}
                                <span class="{% if dias <= 30 %}text-warning{% elif dias <= 60 %}text-info{% else %}text-muted{% endif %}">
                                    {{ dias }} días
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'detalle_lote' lote.pk %}" 
                                   class="btn btn-outline-primary" title="Ver detalle">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if dias < 0 %}
                                <button type="button" class="btn btn-outline-danger" 
                                        title="Marcar como caducado" 
                                        onclick="marcarCaducado({{ lote.pk }})">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-outline-warning" 
                                        title="Crear alerta" 
                                        onclick="crearAlerta({{ lote.pk }})">
                                    <i class="fas fa-bell"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginación -->
        {% if page_obj.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Paginación de alertas">
                <ul class="pagination justify-content-center mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if prioridad_selected %}&prioridad={{ prioridad_selected }}{% endif %}{% if institucion_selected %}&institucion={{ institucion_selected }}{% endif %}{% if search %}&search={{ search }}{% endif %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if prioridad_selected %}&prioridad={{ prioridad_selected }}{% endif %}{% if institucion_selected %}&institucion={{ institucion_selected }}{% endif %}{% if search %}&search={{ search }}{% endif %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if prioridad_selected %}&prioridad={{ prioridad_selected }}{% endif %}{% if institucion_selected %}&institucion={{ institucion_selected }}{% endif %}{% if search %}&search={{ search }}{% endif %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if prioridad_selected %}&prioridad={{ prioridad_selected }}{% endif %}{% if institucion_selected %}&institucion={{ institucion_selected }}{% endif %}{% if search %}&search={{ search }}{% endif %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5 class="text-success">¡Excelente!</h5>
            <p class="text-muted">
                {% if prioridad_selected or institucion_selected or search %}
                    No hay alertas que coincidan con los filtros seleccionados.
                {% else %}
                    No hay productos próximos a caducar en este momento.
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Acciones masivas -->
{% if page_obj %}
<div class="card mt-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-cogs"></i> Acciones Recomendadas
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Para productos caducados:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success"></i> Retirar del inventario disponible</li>
                    <li><i class="fas fa-check text-success"></i> Documentar la baja</li>
                    <li><i class="fas fa-check text-success"></i> Seguir protocolo de disposición</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Para productos próximos a caducar:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-info"></i> Priorizar su uso</li>
                    <li><i class="fas fa-check text-info"></i> Notificar a las áreas correspondientes</li>
                    <li><i class="fas fa-check text-info"></i> Considerar transferencias</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function marcarCaducado(loteId) {
    if (confirm('¿Está seguro de marcar este lote como caducado?')) {
        // Aquí se implementaría la llamada AJAX para marcar como caducado
        fetch(`/lotes/${loteId}/marcar-caducado/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al marcar como caducado');
            }
        });
    }
}

function crearAlerta(loteId) {
    if (confirm('¿Desea crear una alerta para este lote?')) {
        // Aquí se implementaría la llamada AJAX para crear alerta
        fetch(`/lotes/${loteId}/crear-alerta/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Alerta creada exitosamente');
            } else {
                alert('Error al crear la alerta');
            }
        });
    }
}
</script>
{% endblock %}
