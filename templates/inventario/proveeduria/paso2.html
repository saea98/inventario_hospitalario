{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    .select2-container--bootstrap-5 .select2-selection--single {
        height: auto;
        min-height: 38px;
        padding: 4px;
    }

    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        padding: 0;
        line-height: 1.4;
        word-wrap: break-word;
        white-space: normal;
        max-height: 60px;
        overflow-y: auto;
    }

    .select2-results__option {
        padding: 6px 8px;
        white-space: normal;
        word-wrap: break-word;
    }

    .select2-results__option--highlighted {
        background-color: #198754;  /* Verde para PROVEEDURÍA */
    }

    .table-items {
        margin-top: 20px;
    }

    .btn-agregar {
        margin-bottom: 15px;
    }

    .alert-info-custom {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .badge-caducidad {
        font-size: 0.85rem;
        padding: 4px 8px;
    }

    .badge-caducidad.pronto {
        background-color: #ffc107;
        color: #000;
    }

    .badge-caducidad.normal {
        background-color: #28a745;
        color: #fff;
    }

    .resumen-datos {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .resumen-datos p {
        margin: 5px 0;
        font-size: 0.95rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="alert alert-success" role="alert">
        <h4 class="alert-heading">{{ titulo }}</h4>
    </div>

    <!-- Información de progreso -->
    <div class="alert alert-info alert-info-custom" role="alert">
        <i class="fas fa-info-circle"></i>
        <strong>Paso 2 de 3:</strong> Selecciona un producto y luego los lotes disponibles. Los lotes se muestran ordenados por fecha de caducidad (más próximos a caducar primero). Los campos con <span style="color: red;">*</span> son obligatorios.
    </div>

    <!-- Datos de la solicitud -->
    <div class="resumen-datos">
        <p><strong>Solicitud:</strong> {{ proveeduria_data.numero_solicitud }}</p>
        <p><strong>Almacén Origen:</strong> {{ almacen.nombre }}</p>
        <p><strong>Destino:</strong> {{ proveeduria_data.area_destino }}</p>
        <p><strong>Responsable:</strong> {{ proveeduria_data.responsable_solicitud }}</p>
    </div>

    <!-- Formulario de items -->
    <form method="POST" id="formItems">
        {% csrf_token %}

        <!-- Botón Agregar Item -->
        <button type="button" class="btn btn-success btn-agregar" id="btnAgregarItem">
            <i class="fas fa-plus"></i> Agregar Item
        </button>

        <!-- Tabla de items -->
        <div class="table-responsive table-items">
            <table class="table table-bordered table-hover" id="tablaItems">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 25%;">Producto*</th>
                        <th style="width: 20%;">Lote Disponible*</th>
                        <th style="width: 12%;">Disponible</th>
                        <th style="width: 12%;">Caducidad</th>
                        <th style="width: 10%;">Precio Unit.</th>
                        <th style="width: 12%;">Cantidad a Sacar*</th>
                        <th style="width: 15%;">Motivo*</th>
                        <th style="width: 8%;">Acción</th>
                    </tr>
                </thead>
                <tbody id="itemsBody">
                    <!-- Los items se agregan aquí dinámicamente -->
                </tbody>
            </table>
        </div>

        <!-- Input oculto para enviar items como JSON -->
        <input type="hidden" name="items_json" id="itemsJson" value="[]">

        <!-- Resumen -->
        <div class="alert alert-secondary" role="alert">
            <p><strong>Total Items:</strong> <span id="totalItems">0</span></p>
            <p><strong>Total Cantidad a Sacar:</strong> <span id="totalCantidad">0</span></p>
        </div>

        <!-- Botones de acción -->
        <div class="btn-group" role="group">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-arrow-right"></i> Continuar al Paso 3
            </button>
            <a href="{% url 'proveeduria_paso1' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
            <a href="{% url 'proveeduria_paso1' %}" class="btn btn-outline-danger">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<!-- Modal para seleccionar lotes -->
<div class="modal fade" id="modalSeleccionarLote" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Seleccionar Lote</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="lotesListaContainer">
                    <p class="text-muted">Cargando lotes disponibles...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// Datos globales
const productos = {{ productos|safe }};
const almacenId = {{ proveeduria_data.almacen_origen_id }};
let items = {};
let rowIndex = 0;

// Inicializar Select2 para productos
$(document).ready(function() {
    inicializarSelectProductos();
});

function inicializarSelectProductos() {
    // Este select se agregará en cada fila
}

function agregarFila() {
    rowIndex++;
    const row = document.createElement('tr');
    row.id = `item-${rowIndex}`;
    row.innerHTML = `
        <td>
            <select class="form-control producto-select" data-row="${rowIndex}" style="width: 100%;">
                <option value="">-- Selecciona un producto --</option>
                ${productos.map(p => `<option value="${p.id}">${p.clave_cnis}</option>`).join('')}
            </select>
        </td>
        <td>
            <select class="form-control lote-select" data-row="${rowIndex}" style="width: 100%;" disabled>
                <option value="">-- Selecciona un lote --</option>
            </select>
        </td>
        <td>
            <input type="number" class="form-control disponible-input" data-row="${rowIndex}" readonly>
        </td>
        <td>
            <input type="date" class="form-control caducidad-input" data-row="${rowIndex}" readonly>
        </td>
        <td>
            <input type="number" class="form-control precio-input" data-row="${rowIndex}" step="0.01" readonly>
        </td>
        <td>
            <input type="number" class="form-control cantidad-input" data-row="${rowIndex}" min="1" required>
        </td>
        <td>
            <select class="form-control motivo-select" data-row="${rowIndex}" required>
                <option value="">-- Selecciona motivo --</option>
                <option value="Distribución">Distribución</option>
                <option value="Reposición">Reposición</option>
                <option value="Devolución">Devolución</option>
                <option value="Ajuste">Ajuste</option>
                <option value="Otro">Otro</option>
            </select>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarFila(${rowIndex})">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    
    document.getElementById('itemsBody').appendChild(row);
    
    // Inicializar Select2 para el producto
    const selectProducto = row.querySelector(`[data-row="${rowIndex}"].producto-select`);
    $(selectProducto).select2({
        theme: 'bootstrap-5',
        placeholder: '-- Selecciona un producto --',
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return 'No se encontraron productos';
            }
        }
    });
    
    // Evento: cuando se selecciona un producto
    $(selectProducto).on('change', function() {
        const productoId = $(this).val();
        const selectLote = row.querySelector(`[data-row="${rowIndex}"].lote-select`);
        
        if (productoId) {
            // Habilitar select de lotes
            $(selectLote).prop('disabled', false);
            cargarLotesDelProducto(productoId, rowIndex);
        } else {
            // Deshabilitar select de lotes
            $(selectLote).prop('disabled', true);
            $(selectLote).html('<option value="">-- Selecciona un lote --</option>');
        }
    });
    
    // Inicializar Select2 para el lote
    const selectLote = row.querySelector(`[data-row="${rowIndex}"].lote-select`);
    $(selectLote).select2({
        theme: 'bootstrap-5',
        placeholder: '-- Selecciona un lote --',
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return 'No hay lotes disponibles';
            }
        }
    });
    
    // Evento: cuando se selecciona un lote
    $(selectLote).on('change', function() {
        const loteId = $(this).val();
        if (loteId) {
            cargarDetallesLote(loteId, rowIndex);
        }
    });
    
    // Evento: cuando cambia la cantidad
    const inputCantidad = row.querySelector(`[data-row="${rowIndex}"].cantidad-input`);
    inputCantidad.addEventListener('change', actualizarResumen);
    inputCantidad.addEventListener('input', actualizarResumen);
}

function cargarLotesDelProducto(productoId, rowIndex) {
    // Llamar al endpoint AJAX para obtener lotes del producto
    fetch(`/inventario/api/lotes-por-producto/?producto_id=${productoId}&almacen_id=${almacenId}`)
        .then(response => response.json())
        .then(data => {
            const selectLote = document.querySelector(`[data-row="${rowIndex}"].lote-select`);
            
            if (data.lotes && data.lotes.length > 0) {
                // Construir opciones ordenadas por caducidad
                let html = '<option value="">-- Selecciona un lote --</option>';
                data.lotes.forEach(lote => {
                    const diasCaducidad = lote.dias_caducidad !== null ? lote.dias_caducidad : 999;
                    const etiquetaCaducidad = diasCaducidad < 30 ? ` (⚠️ ${diasCaducidad} días)` : '';
                    html += `<option value="${lote.id}" title="${lote.numero_lote} - ${lote.producto__descripcion}">${lote.numero_lote}${etiquetaCaducidad}</option>`;
                });
                selectLote.innerHTML = html;
                
                // Reinicializar Select2
                $(selectLote).select2({
                    theme: 'bootstrap-5',
                    placeholder: '-- Selecciona un lote --',
                    allowClear: true,
                    width: '100%'
                });
            } else {
                selectLote.innerHTML = '<option value="">-- No hay lotes disponibles --</option>';
                $(selectLote).select2({
                    theme: 'bootstrap-5',
                    placeholder: '-- No hay lotes disponibles --',
                    allowClear: true,
                    width: '100%'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los lotes');
        });
}

function cargarDetallesLote(loteId, rowIndex) {
    fetch(`/inventario/api/detalles-lote/?lote_id=${loteId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            // Llenar los campos
            document.querySelector(`[data-row="${rowIndex}"].disponible-input`).value = data.cantidad_disponible;
            document.querySelector(`[data-row="${rowIndex}"].caducidad-input`).value = data.fecha_caducidad || '';
            document.querySelector(`[data-row="${rowIndex}"].precio-input`).value = data.precio_unitario.toFixed(2);
            
            // Guardar datos en el objeto items
            items[rowIndex] = {
                lote_id: loteId,
                cantidad_disponible: data.cantidad_disponible,
                precio_unitario: data.precio_unitario,
            };
            
            actualizarResumen();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar los detalles del lote');
        });
}

function eliminarFila(rowIndex) {
    const row = document.getElementById(`item-${rowIndex}`);
    if (row) {
        // Destruir Select2 antes de eliminar
        const selectProducto = row.querySelector(`[data-row="${rowIndex}"].producto-select`);
        const selectLote = row.querySelector(`[data-row="${rowIndex}"].lote-select`);
        
        if (selectProducto && $.fn.select2) {
            $(selectProducto).select2('destroy');
        }
        if (selectLote && $.fn.select2) {
            $(selectLote).select2('destroy');
        }
        
        row.remove();
        delete items[rowIndex];
        actualizarResumen();
    }
}

function actualizarResumen() {
    let totalItems = 0;
    let totalCantidad = 0;
    
    // Contar items con datos válidos
    document.querySelectorAll('#itemsBody tr').forEach(row => {
        const selectLote = row.querySelector('.lote-select');
        const inputCantidad = row.querySelector('.cantidad-input');
        
        if (selectLote && selectLote.value && inputCantidad && inputCantidad.value) {
            totalItems++;
            totalCantidad += parseInt(inputCantidad.value) || 0;
        }
    });
    
    document.getElementById('totalItems').textContent = totalItems;
    document.getElementById('totalCantidad').textContent = totalCantidad;
}

function recopilarItems() {
    const itemsArray = [];
    
    document.querySelectorAll('#itemsBody tr').forEach(row => {
        const selectLote = row.querySelector('.lote-select');
        const inputCantidad = row.querySelector('.cantidad-input');
        const selectMotivo = row.querySelector('.motivo-select');
        
        if (selectLote && selectLote.value && inputCantidad && inputCantidad.value && selectMotivo && selectMotivo.value) {
            itemsArray.push({
                lote_id: parseInt(selectLote.value),
                cantidad_salida: parseInt(inputCantidad.value),
                motivo_salida: selectMotivo.value,
            });
        }
    });
    
    return itemsArray;
}

// Evento: Agregar Item
document.getElementById('btnAgregarItem').addEventListener('click', agregarFila);

// Evento: Enviar formulario
document.getElementById('formItems').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const items = recopilarItems();
    
    if (items.length === 0) {
        alert('Debes agregar al menos un item con todos los datos requeridos');
        return;
    }
    
    // Validar cantidades
    let valido = true;
    document.querySelectorAll('#itemsBody tr').forEach(row => {
        const selectLote = row.querySelector('.lote-select');
        const inputCantidad = row.querySelector('.cantidad-input');
        const disponibleInput = row.querySelector('.disponible-input');
        
        if (selectLote && selectLote.value && inputCantidad && inputCantidad.value) {
            const cantidad = parseInt(inputCantidad.value);
            const disponible = parseInt(disponibleInput.value);
            
            if (cantidad > disponible) {
                alert(`La cantidad a sacar (${cantidad}) no puede ser mayor a la disponible (${disponible})`);
                valido = false;
            }
        }
    });
    
    if (!valido) return;
    
    // Guardar items en el input oculto
    document.getElementById('itemsJson').value = JSON.stringify(items);
    
    // Enviar formulario
    this.submit();
});

// Agregar primera fila automáticamente
document.addEventListener('DOMContentLoaded', function() {
    agregarFila();
});
</script>
{% endblock %}
