{% extends 'base.html' %}
{% load static %}

{% block title %}Picking - {{ propuesta.solicitud.folio }}{% endblock %}

{% block content %}
<style>
    /* Estilos optimizados para tablet */
    .picking-container {
        max-width: 100%;
        margin: 0;
        padding: 10px;
    }
    
    .picking-header {
        background: linear-gradient(135deg, #1f77b4 0%, #1557a0 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .picking-header h1 {
        margin: 0;
        font-size: 24px;
    }
    
    .picking-header .info {
        text-align: right;
    }
    
    .picking-header .info p {
        margin: 5px 0;
        font-size: 14px;
    }
    
    .controles {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }
    
    .controles button, .controles select {
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        flex: 1;
        min-width: 150px;
    }
    
    .btn-imprimir {
        background-color: #28a745;
        color: white;
    }
    
    .btn-imprimir:hover {
        background-color: #218838;
    }
    
    .btn-volver {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-volver:hover {
        background-color: #5a6268;
    }
    
    select {
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
    }
    
    .ubicacion-grupo {
        background: white;
        border: 2px solid #1f77b4;
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
    }
    
    .ubicacion-titulo {
        background-color: #1f77b4;
        color: white;
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
        margin: 0;
    }
    
    .item-picking {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        background-color: #f8f9fa;
        margin: 5px;
        border-radius: 6px;
    }
    
    .item-picking:last-child {
        border-bottom: none;
    }
    
    .item-picking.recogido {
        background-color: #d4edda;
        opacity: 0.7;
    }
    
    .item-info {
        flex: 1;
    }
    
    .item-producto {
        font-size: 16px;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
    
    .item-detalles {
        font-size: 13px;
        color: #666;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    
    .item-cantidad {
        background-color: #1f77b4;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 18px;
        font-weight: bold;
        min-width: 80px;
        text-align: center;
    }
    
    .btn-recoger {
        padding: 12px 20px;
        font-size: 16px;
        background-color: #ffc107;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        min-width: 120px;
    }
    
    .btn-recoger:hover {
        background-color: #e0a800;
    }
    
    .btn-recoger:disabled {
        background-color: #28a745;
        color: white;
        cursor: not-allowed;
    }
    
    .btn-corregir-lote {
        padding: 10px 14px;
        font-size: 14px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    .btn-corregir-lote:hover {
        background-color: #5a6268;
    }
    .btn-cambiar-cantidad {
        padding: 10px 14px;
        font-size: 14px;
        background-color: #17a2b8;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    .btn-cambiar-cantidad:hover {
        background-color: #138496;
    }
    .modal-overlay-corregir {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal-overlay-corregir.activo { display: flex; }
    .modal-corregir-lote-box {
        background: white;
        border-radius: 8px;
        padding: 20px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .modal-corregir-lote-box h3 { margin-top: 0; }
    .modal-corregir-lote-box select, .modal-corregir-lote-box input[type="number"] { width: 100%; padding: 10px; margin: 10px 0; font-size: 14px; box-sizing: border-box; }
    .modal-corregir-lote-box .botones { margin-top: 16px; display: flex; gap: 10px; justify-content: flex-end; }
    
    .resumen {
        background: white;
        border: 2px solid #1f77b4;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        text-align: center;
    }
    
    .resumen-item {
        padding: 10px;
    }
    
    .resumen-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
    }
    
    .resumen-valor {
        font-size: 24px;
        font-weight: bold;
        color: #1f77b4;
    }
    
    .progreso-barra {
        width: 100%;
        height: 30px;
        background-color: #e9ecef;
        border-radius: 6px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .progreso-relleno {
        height: 100%;
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        transition: width 0.3s ease;
    }
    
    @media (max-width: 768px) {
        .picking-header {
            flex-direction: column;
            text-align: center;
        }
        
        .picking-header .info {
            text-align: center;
            margin-top: 10px;
        }
        
        .controles {
            flex-direction: column;
        }
        
        .controles button, .controles select {
            flex: none;
            width: 100%;
        }
        
        .item-picking {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .item-cantidad, .btn-recoger {
            width: 100%;
        }
    }
</style>

<div class="picking-container">
    <!-- Header -->
    <div class="picking-header">
        <div>
            <h1><i class="fas fa-dolly"></i> PICKING</h1>
        </div>
        <div class="info">
            <p><strong>Propuesta:</strong> {{ propuesta.solicitud.folio }}</p>
            <p><strong>Folio de Pedido:</strong> <code>{{ propuesta.solicitud.observaciones_solicitud|default:"N/A" }}</code></p>
            <p><strong>Total Items:</strong> <span id="total-items">{{ total_items }}</span></p>
        </div>
    </div>
    
    <!-- Controles -->
    <div class="controles">
        <select id="orden-select" onchange="cambiarOrden(this.value)">
            <option value="ubicacion" {% if orden_picking == 'ubicacion' %}selected{% endif %}>Ordenar por Ubicación</option>
            <option value="producto" {% if orden_picking == 'producto' %}selected{% endif %}>Ordenar por Producto</option>
            <option value="cantidad" {% if orden_picking == 'cantidad' %}selected{% endif %}>Ordenar por Cantidad</option>
        </select>
        
        <a href="{% url 'logistica:imprimir_hoja_surtido' propuesta.id %}" class="btn btn-imprimir">
            <i class="fas fa-print"></i> Imprimir Hoja de Surtido
        </a>
        
        <a href="{% url 'logistica:exportar_picking_excel' propuesta.id %}" class="btn btn-imprimir" style="background-color: #007bff;">
            <i class="fas fa-file-excel"></i> Exportar a Excel
        </a>
        
        <button class="btn-volver" onclick="window.history.back()">
            <i class="fas fa-arrow-left"></i> Volver
        </button>
    </div>
    
    <!-- Resumen de progreso -->
    <div class="resumen">
        <div class="resumen-item">
            <div class="resumen-label">Recogidos</div>
            <div class="resumen-valor" id="recogidos">0</div>
        </div>
        <div class="resumen-item">
            <div class="resumen-label">Pendientes</div>
            <div class="resumen-valor" id="pendientes">{{ total_items }}</div>
        </div>
        <div class="resumen-item">
            <div class="resumen-label">Progreso</div>
            <div class="resumen-valor" id="porcentaje">0%</div>
        </div>
    </div>
    
    <!-- Barra de progreso -->
    <div class="progreso-barra">
        <div class="progreso-relleno" id="progreso-relleno" style="width: 0%">
            <span id="progreso-texto">0%</span>
        </div>
    </div>
    
    <!-- Items de picking agrupados por ubicación -->
    <div style="margin-top: 20px;">
        {% for ubicacion, items in ubicaciones_agrupadas.items %}
        <div class="ubicacion-grupo">
            <h3 class="ubicacion-titulo">
                <i class="fas fa-map-marker-alt"></i> {{ ubicacion }}
            </h3>
            
            {% for item in items %}
            <div class="item-picking" id="item-{{ item.lote_asignado_id }}">
                <div class="item-info">
                    <div class="item-producto">{{ item.producto }}</div>
                    <div class="item-detalles">
                        <div><strong>Lote:</strong> {{ item.lote_numero }}</div>
                        <div><strong>CNIS:</strong> {{ item.clave_cnis }}</div>
                    </div>
                </div>
                
                <div class="item-cantidad">{{ item.cantidad }}</div>
                
                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <button type="button" class="btn-corregir-lote"
                            data-lote-asignado-id="{{ item.lote_asignado_id }}"
                            data-lote-actual="{{ item.lote_numero }}"
                            data-producto="{{ item.producto }}"
                            onclick="abrirModalCorregirLote(this)">
                        Corregir lote
                    </button>
                    <button type="button" class="btn-cambiar-cantidad"
                            data-lote-asignado-id="{{ item.lote_asignado_id }}"
                            data-cantidad-actual="{{ item.cantidad }}"
                            data-producto="{{ item.producto }}"
                            onclick="abrirModalCambiarCantidad(this)">
                        Cambiar cantidad
                    </button>
                    <button class="btn-recoger" 
                            id="btn-{{ item.lote_asignado_id }}"
                            onclick="marcarRecogido('{{ item.lote_asignado_id }}', this)">
                        Recoger
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Corregir lote: seleccionar otro lote de la misma clave -->
<div class="modal-overlay-corregir" id="modalCorregirLote">
    <div class="modal-corregir-lote-box">
        <h3><i class="fas fa-edit"></i> Corregir lote</h3>
        <p class="mb-2">Producto: <strong id="modalProducto"></strong></p>
        <p class="mb-2">Lote actual: <strong id="modalLoteActual"></strong></p>
        <p class="small text-muted">Seleccione el lote correcto (misma clave). Se liberará la reserva del lote actual y se reservará en el lote elegido; se generarán los movimientos de inventario como en la liberación de reservas.</p>
        <label for="selectNuevoLote">Lote correcto:</label>
        <select id="selectNuevoLote">
            <option value="">-- Cargando opciones --</option>
        </select>
        <div class="botones">
            <button type="button" class="btn-volver" id="btnCerrarModalCorregir">Cancelar</button>
            <button type="button" class="btn-imprimir" id="btnAplicarCorregirLote">Aplicar</button>
        </div>
    </div>
</div>

<!-- Modal Cambiar cantidad -->
<div class="modal-overlay-corregir" id="modalCambiarCantidad">
    <div class="modal-corregir-lote-box">
        <h3><i class="fas fa-sort-numeric-up"></i> Cambiar cantidad</h3>
        <p class="mb-2">Producto: <strong id="modalCantProducto"></strong></p>
        <p class="mb-2">Cantidad actual: <strong id="modalCantActual"></strong></p>
        <p class="small text-muted" id="modalCantLimites">Puede ser menor a lo solicitado o cero si el hospital no se lleva el insumo o lleva menos. Máximo: disponible (cantidad − reservada) en este lote/ubicación. Se generará registro de movimiento de inventario como evidencia.</p>
        <label for="inputNuevaCantidad">Nueva cantidad (0 = quitar línea y liberar reserva):</label>
        <input type="number" id="inputNuevaCantidad" class="form-control" min="0" step="1" placeholder="0 o más">
        <div class="botones mt-3">
            <button type="button" class="btn-volver" id="btnCerrarModalCantidad">Cancelar</button>
            <button type="button" class="btn-imprimir" id="btnAplicarCantidad">Aplicar</button>
        </div>
    </div>
</div>

<script>
    function cambiarOrden(orden) {
        const url = new URL(window.location);
        url.searchParams.set('orden', orden);
        window.location.href = url.toString();
    }
    
    function marcarRecogido(loteAsignadoId, button) {
        if (button.disabled) return;
        button.disabled = true;
        const textoOriginal = button.textContent;
        button.textContent = '...';
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name="csrf-token"]')?.content;
        
        fetch(`/picking/marcar-recogido/${loteAsignadoId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(function(response) {
            return response.json().then(function(data) {
                if (response.ok && data.exito) {
                    const itemDiv = document.getElementById(`item-${loteAsignadoId}`);
                    itemDiv.classList.add('recogido');
                    button.disabled = true;
                    button.textContent = '✓ Recogido';
                    actualizarProgreso();
                } else {
                    button.textContent = 'Ya recogido';
                    button.title = data.mensaje || 'Otro usuario ya recogió este ítem';
                    alert((data.mensaje || 'Este ítem ya fue recogido por otro usuario.') + ' La página se reiniciará al aceptar.');
                    window.location.reload();
                }
            });
        })
        .catch(function(error) {
            console.error('Error:', error);
            button.disabled = false;
            button.textContent = textoOriginal;
            alert('Error al marcar como recogido');
        });
    }
    
    function actualizarProgreso() {
        const total = {{ total_items }};
        const recogidos = document.querySelectorAll('.item-picking.recogido').length;
        const pendientes = total - recogidos;
        const porcentaje = Math.round((recogidos / total) * 100);
        
        document.getElementById('recogidos').textContent = recogidos;
        document.getElementById('pendientes').textContent = pendientes;
        document.getElementById('porcentaje').textContent = porcentaje + '%';
        document.getElementById('progreso-relleno').style.width = porcentaje + '%';
        document.getElementById('progreso-texto').textContent = porcentaje + '%';
    }
    
    var loteAsignadoIdCorregir = null;
    var modalCorregir = document.getElementById('modalCorregirLote');
    var selectNuevoLote = document.getElementById('selectNuevoLote');
    var urlBasePicking = '/picking';
    
    function abrirModalCorregirLote(btn) {
        loteAsignadoIdCorregir = btn.getAttribute('data-lote-asignado-id');
        document.getElementById('modalProducto').textContent = btn.getAttribute('data-producto') || '';
        document.getElementById('modalLoteActual').textContent = btn.getAttribute('data-lote-actual') || '';
        modalCorregir.classList.add('activo');
        selectNuevoLote.innerHTML = '<option value="">-- Cargando opciones --</option>';
        selectNuevoLote.disabled = true;
        fetch(urlBasePicking + '/ubicaciones-para-corregir-lote/?lote_asignado_id=' + encodeURIComponent(loteAsignadoIdCorregir))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                selectNuevoLote.innerHTML = '<option value="">-- Elija el lote correcto --</option>';
                if (data.opciones && data.opciones.length) {
                    data.opciones.forEach(function(o) {
                        var opt = document.createElement('option');
                        opt.value = o.id;
                        opt.textContent = o.lote + ' - ' + (o.codigo || '') + ' (disp: ' + o.cantidad_disponible + ', F_CAD: ' + (o.fecha_caducidad || '') + ')';
                        selectNuevoLote.appendChild(opt);
                    });
                } else {
                    selectNuevoLote.innerHTML = '<option value="">No hay lotes alternativos disponibles</option>';
                }
                selectNuevoLote.disabled = false;
            })
            .catch(function() {
                selectNuevoLote.innerHTML = '<option value="">Error al cargar opciones</option>';
                selectNuevoLote.disabled = false;
            });
    }
    document.getElementById('btnCerrarModalCorregir').addEventListener('click', function() {
        modalCorregir.classList.remove('activo');
        loteAsignadoIdCorregir = null;
    });
    modalCorregir.addEventListener('click', function(e) {
        if (e.target === modalCorregir) modalCorregir.classList.remove('activo');
    });
    document.getElementById('btnAplicarCorregirLote').addEventListener('click', function() {
        if (!loteAsignadoIdCorregir) return;
        var nuevoId = selectNuevoLote.value;
        if (!nuevoId) { alert('Seleccione un lote correcto.'); return; }
        var boton = this;
        boton.disabled = true;
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.content;
        fetch(urlBasePicking + '/corregir-lote/' + loteAsignadoIdCorregir + '/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ nuevo_lote_ubicacion_id: nuevoId })
        })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(result) {
            if (result.ok && result.data.exito) {
                alert(result.data.mensaje || 'Lote corregido.');
                modalCorregir.classList.remove('activo');
                window.location.reload();
            } else {
                alert(result.data.mensaje || 'Error al corregir el lote.');
                boton.disabled = false;
            }
        })
        .catch(function() { alert('Error de conexión.'); boton.disabled = false; });
    });
    
    var loteAsignadoIdCantidad = null;
    var modalCantidad = document.getElementById('modalCambiarCantidad');
    var inputNuevaCantidad = document.getElementById('inputNuevaCantidad');
    
    function abrirModalCambiarCantidad(btn) {
        loteAsignadoIdCantidad = btn.getAttribute('data-lote-asignado-id');
        var cantidadActual = btn.getAttribute('data-cantidad-actual') || '0';
        document.getElementById('modalCantProducto').textContent = btn.getAttribute('data-producto') || '';
        document.getElementById('modalCantActual').textContent = cantidadActual;
        inputNuevaCantidad.value = cantidadActual;
        inputNuevaCantidad.min = '1';
        modalCantidad.classList.add('activo');
        fetch(urlBasePicking + '/limites-cantidad/' + loteAsignadoIdCantidad + '/')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.error) {
                    document.getElementById('modalCantLimites').textContent = data.error;
                    inputNuevaCantidad.placeholder = 'No disponible';
                    return;
                }
                var min = data.minimo !== undefined ? data.minimo : 0;
                var max = data.maximo_disponible || 99999;
                inputNuevaCantidad.min = min;
                inputNuevaCantidad.max = max;
                inputNuevaCantidad.placeholder = 'Entre ' + min + ' y ' + max + ' (0 = no se lleva)';
                document.getElementById('modalCantLimites').textContent = 'Puede ser menor a lo solicitado o cero (hospital no se lleva el insumo o lleva menos). Mínimo: ' + min + ', máximo: ' + max + '. Se generará movimiento de inventario como evidencia.';
            })
            .catch(function() {
                document.getElementById('modalCantLimites').textContent = 'No se pudieron cargar los límites.';
            });
        inputNuevaCantidad.focus();
    }
    document.getElementById('btnCerrarModalCantidad').addEventListener('click', function() {
        modalCantidad.classList.remove('activo');
        loteAsignadoIdCantidad = null;
    });
    modalCantidad.addEventListener('click', function(e) {
        if (e.target === modalCantidad) modalCantidad.classList.remove('activo');
    });
    document.getElementById('btnAplicarCantidad').addEventListener('click', function() {
        if (!loteAsignadoIdCantidad) return;
        var val = parseInt(inputNuevaCantidad.value, 10);
        if (isNaN(val) || val < 0) {
            alert('Indique una cantidad válida (entero mayor o igual a 0).');
            return;
        }
        var boton = this;
        boton.disabled = true;
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.content;
        fetch(urlBasePicking + '/cambiar-cantidad/' + loteAsignadoIdCantidad + '/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ nueva_cantidad: val })
        })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(result) {
            if (result.ok && result.data.exito) {
                alert(result.data.mensaje || 'Cantidad actualizada.');
                modalCantidad.classList.remove('activo');
                window.location.reload();
            } else {
                alert(result.data.mensaje || 'Error al cambiar la cantidad.');
                boton.disabled = false;
            }
        })
        .catch(function() { alert('Error de conexión.'); boton.disabled = false; });
    });
</script>
{% endblock %}
