{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container-fluid">
    <h1 class="h3 mb-4 text-gray-800">{{ page_title|default:'Crear Nueva Solicitud de Pedido' }}</h1>

    <form method="post">
        {% csrf_token %}
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Datos de la Solicitud</h6>
            </div>
            <div class="card-body">
                {{ form|crispy }}
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Items de la Solicitud</h6>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                <div id="item-forms-container">
                    {% for form in formset %}
                        <div class="item-form mb-3">
                            <div class="row">
                                <div class="col-md-8">{{ form.producto|as_crispy_field }}</div>
                                <div class="col-md-3">{{ form.cantidad_solicitada|as_crispy_field }}</div>
                                <div class="col-md-1 d-flex align-items-center">
                                    {% if form.instance.pk %}
                                        {{ form.DELETE }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-item-form" class="btn btn-secondary btn-sm">AÃ±adir otro item</button>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Guardar Solicitud</button>
        <a href="{% url 'logistica:lista_pedidos' %}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>

{% block extra_js %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar Select2 para campos existentes
        $('.select2-single').select2({
            width: '100%',
            language: 'es'
        });

        const container = document.getElementById('item-forms-container');
        const addButton = document.getElementById('add-item-form');
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        let formCount = parseInt(totalForms.value);

        addButton.addEventListener('click', function() {
            const newForm = container.children[0].cloneNode(true);
            const formRegex = new RegExp('items-(\\d+)-', 'g');
            
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, 'items-' + formCount + '-');
            container.appendChild(newForm);
            
            // Reinicializar Select2 para el nuevo formulario
            newForm.querySelectorAll('.select2-single').forEach(function(element) {
                $(element).select2({
                    width: '100%',
                    language: 'es'
                });
            });
            
            totalForms.value = ++formCount;
        });
    });
</script>
{% endblock %}
{% endblock %}
