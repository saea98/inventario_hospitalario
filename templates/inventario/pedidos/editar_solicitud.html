{% extends 'base.html' %}

{% block content %}
<style>
    /* Asegurar que los selects en filas nuevas sean visibles cuando la fila se muestra */
    tr.new-item-row[style*="display: table-row"] td.producto-cell,
    tr.new-item-row:not([style*="display: none"]) td.producto-cell {
        display: table-cell !important;
        visibility: visible !important;
    }
    tr.new-item-row:not([style*="display: none"]) td.producto-cell select {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: 100% !important;
    }
</style>
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">{{ page_title }}</h1>
        <a href="{% url 'logistica:detalle_pedido' solicitud.id %}" class="btn btn-secondary btn-icon-split">
            <span class="icon text-white-50"><i class="fas fa-arrow-left"></i></span>
            <span class="text">Volver</span>
        </a>
    </div>

    <form method="post">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-lg-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Informaci√≥n de la Solicitud</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label><strong>Folio:</strong></label>
                                    <p class="form-control-plaintext">{{ solicitud.folio }}</p>
                                </div>
                                <div class="form-group">
                                    <label for="{{ form_encabezado.institucion_solicitante.id_for_label }}"><strong>Instituci√≥n Solicitante:</strong></label>
                                    {{ form_encabezado.institucion_solicitante }}
                                    {% if form_encabezado.institucion_solicitante.errors %}
                                        <div class="text-danger small">
                                            {{ form_encabezado.institucion_solicitante.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="{{ form_encabezado.almacen_destino.id_for_label }}"><strong>Almac√©n Destino:</strong></label>
                                    {{ form_encabezado.almacen_destino }}
                                    {% if form_encabezado.almacen_destino.errors %}
                                        <div class="text-danger small">
                                            {{ form_encabezado.almacen_destino.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form_encabezado.fecha_solicitud.id_for_label }}"><strong>Fecha de Solicitud:</strong></label>
                                    {{ form_encabezado.fecha_solicitud }}
                                    {% if form_encabezado.fecha_solicitud.errors %}
                                        <div class="text-danger small">
                                            {{ form_encabezado.fecha_solicitud.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="{{ form_encabezado.fecha_entrega_programada.id_for_label }}"><strong>Fecha de Entrega Programada:</strong></label>
                                    {{ form_encabezado.fecha_entrega_programada }}
                                    {% if form_encabezado.fecha_entrega_programada.errors %}
                                        <div class="text-danger small">
                                            {{ form_encabezado.fecha_entrega_programada.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label><strong>Estado:</strong></label>
                                    <p class="form-control-plaintext"><span class="badge badge-info">{{ solicitud.get_estado_display }}</span></p>
                                </div>
                                <div class="form-group">
                                    <label for="{{ form_encabezado.observaciones_solicitud.id_for_label }}"><strong>Folio del Pedido (Observaciones):</strong></label>
                                    {{ form_encabezado.observaciones_solicitud }}
                                    <div id="folio-pedido-aviso" class="mt-2" style="display: none;" aria-live="polite"></div>
                                    {% if form_encabezado.observaciones_solicitud.errors %}
                                        <div class="text-danger small">
                                            {{ form_encabezado.observaciones_solicitud.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Editar Items de la Solicitud</h6>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                
                <div class="table-responsive">
                    <table class="table table-bordered" id="items-table">
                        <thead>
                            <tr>
                                <th>Producto (CNIS)</th>
                                <th>Descripci√≥n</th>
                                <th>Cantidad Solicitada</th>
                                <th>Cantidad Aprobada</th>
                                <th>Justificaci√≥n</th>
                                <th>Eliminar</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for form in formset %}
                                <tr class="item-row {% if not form.instance.pk %}new-item-row{% endif %}" 
                                    {% if form.DELETE.value %}style="display: none;"{% elif not form.instance.pk %}style="display: none;"{% endif %}>
                                    {% if form.instance.pk %}
                                        {# Item existente - mostrar datos y permitir editar cantidad #}
                                        <td>
                                            <strong>{{ form.instance.producto.clave_cnis }}</strong>
                                            {{ form.producto.as_hidden }}
                                        </td>
                                        <td>{{ form.instance.producto.descripcion|truncatechars:50 }}</td>
                                        <td>
                                            {{ form.cantidad_solicitada }}
                                            {% if form.cantidad_solicitada.errors %}
                                                <div class="text-danger small">
                                                    {{ form.cantidad_solicitada.errors }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ form.cantidad_aprobada }}
                                            {% if form.cantidad_aprobada.errors %}
                                                <div class="text-danger small">
                                                    {{ form.cantidad_aprobada.errors }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ form.justificacion_cambio }}
                                            {% if form.justificacion_cambio.errors %}
                                                <div class="text-danger small">
                                                    {{ form.justificacion_cambio.errors }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <label class="form-check-label">
                                                {{ form.DELETE }} Eliminar
                                            </label>
                                        </td>
                                    {% else %}
                                        {# Item nuevo - mostrar campos para agregar #}
                                        <td class="producto-cell" style="min-width: 250px;">
                                            {{ form.producto }}
                                            {% if form.producto.errors %}
                                                <div class="text-danger small">
                                                    {{ form.producto.errors }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="text-muted" id="descripcion_{{ forloop.counter0 }}">-</span>
                                        </td>
                                        <td>
                                            {{ form.cantidad_solicitada }}
                                            {% if form.cantidad_solicitada.errors %}
                                                <div class="text-danger small">
                                                    {{ form.cantidad_solicitada.errors }}
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="text-muted">-</span>
                                            {{ form.cantidad_aprobada.as_hidden }}
                                        </td>
                                        <td>
                                            <span class="text-muted">-</span>
                                            {{ form.justificacion_cambio.as_hidden }}
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-danger remove-row">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    {% endif %}
                                    {{ form.id }}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-success" id="add-item-btn">
                        <i class="fas fa-plus"></i> Agregar Item
                    </button>
                </div>
                
                {% if formset.non_form_errors %}
                    <div class="alert alert-danger">
                        {{ formset.non_form_errors }}
                    </div>
                {% endif %}
                
                <div class="mt-3">
                    <button type="submit" class="btn btn-success btn-icon-split">
                        <span class="icon text-white-50"><i class="fas fa-save"></i></span>
                        <span class="text">Guardar Cambios</span>
                    </button>
                    <a href="{% url 'logistica:detalle_pedido' solicitud.id %}" class="btn btn-secondary">
                        Cancelar
                    </a>
                </div>
            </div>
        </div>
    </form>

    {% if propuesta %}
    <div class="alert alert-info">
        <strong>Nota:</strong> Al guardar los cambios, la propuesta actual ser√° cancelada y se generar√° una nueva propuesta con los items modificados.
    </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîµ [DEBUG] Inicializando script de editar solicitud...');
    
    // Funci√≥n para actualizar descripci√≥n cuando se selecciona un producto
    function updateDescription(selectElement) {
        console.log('üü¢ [DEBUG] updateDescription llamado para:', selectElement);
        const row = selectElement.closest('tr');
        const descripcionCell = row.querySelector('[id^="descripcion_"]');
        if (descripcionCell && selectElement.value) {
            // Obtener descripci√≥n del option seleccionado
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const descripcion = selectedOption.text.split(' - ').slice(1).join(' - ') || selectedOption.text;
            descripcionCell.textContent = descripcion || '-';
            console.log('üü¢ [DEBUG] Descripci√≥n actualizada:', descripcion);
        }
    }
    
    // Inicializar Select2 para todos los selects de producto (items nuevos)
    function initializeProductSelects() {
        document.querySelectorAll('select[name$="-producto"]').forEach(function(select) {
            const row = select.closest('tr');
            const idField = row.querySelector('input[name$="-id"]');
            // Solo para items nuevos (sin id) y que no est√©n ocultos
            if ((!idField || !idField.value) && row.style.display !== 'none') {
                // Inicializar Select2 si no est√° ya inicializado
                if (!$(select).hasClass('select2-hidden-accessible')) {
                    $(select).select2({
                        placeholder: 'Busca por CNIS o descripci√≥n',
                        allowClear: true,
                        width: '100%',
                        language: 'es'
                    });
                }
                
                select.addEventListener('change', function() {
                    updateDescription(this);
                });
                // Actualizar descripci√≥n inicial si ya tiene valor
                if (select.value) {
                    updateDescription(select);
                }
            }
        });
    }
    
    // Inicializar al cargar la p√°gina
    initializeProductSelects();
    
    // Bot√≥n para agregar nuevo item
    const addItemBtn = document.getElementById('add-item-btn');
    console.log('üîµ [DEBUG] Bot√≥n agregar item encontrado:', addItemBtn ? 'S√ç' : 'NO');
    
    if (addItemBtn) {
        addItemBtn.addEventListener('click', function() {
            console.log('üü° [DEBUG] Click en bot√≥n Agregar Item');
            const formset = document.querySelector('#items-table tbody');
            console.log('üü° [DEBUG] Formset encontrado:', formset ? 'S√ç' : 'NO');
            
            if (!formset) {
                console.error('‚ùå [DEBUG] No se encontr√≥ el tbody con id="items-table"');
                return;
            }
            
            // Buscar la primera fila oculta (item nuevo sin datos)
            // Las filas nuevas pueden estar ocultas por style="display: none;" en el atributo HTML
            const allNewRows = Array.from(formset.querySelectorAll('tr.new-item-row'));
            console.log('üü° [DEBUG] Total filas con clase new-item-row:', allNewRows.length);
            
            const hiddenRows = allNewRows.filter(function(row, index) {
                // Verificar si est√° oculta por el atributo style
                const styleAttr = row.getAttribute('style') || '';
                const isHiddenByStyle = styleAttr.includes('display: none');
                
                // Verificar si est√° oculta por la propiedad style
                const computedStyle = window.getComputedStyle(row);
                const isHiddenByComputed = computedStyle.display === 'none';
                
                // Verificar si el select de producto est√° vac√≠o (sin valor seleccionado)
                const productoSelect = row.querySelector('select[name$="-producto"]');
                const hasNoProduct = !productoSelect || !productoSelect.value || productoSelect.value === '';
                
                console.log(`üü° [DEBUG] Fila ${index}:`, {
                    'styleAttr': styleAttr,
                    'isHiddenByStyle': isHiddenByStyle,
                    'computedDisplay': computedStyle.display,
                    'isHiddenByComputed': isHiddenByComputed,
                    'hasSelect': !!productoSelect,
                    'selectValue': productoSelect ? productoSelect.value : 'N/A',
                    'hasNoProduct': hasNoProduct,
                    'isHidden': (isHiddenByStyle || isHiddenByComputed) && hasNoProduct
                });
                
                // La fila est√° oculta si est√° oculta por estilo Y no tiene producto seleccionado
                return (isHiddenByStyle || isHiddenByComputed) && hasNoProduct;
            });
            
            console.log('üü¢ [DEBUG] Total filas nuevas:', allNewRows.length);
            console.log('üü¢ [DEBUG] Filas ocultas encontradas:', hiddenRows.length);
            
            if (hiddenRows.length > 0) {
                console.log('üü¢ [DEBUG] Mostrando primera fila oculta');
                // Mostrar la primera fila oculta
                const firstRow = hiddenRows[0];
                const $firstRow = $(firstRow);
                
                console.log('üü° [DEBUG] Fila seleccionada:', firstRow);
                console.log('üü° [DEBUG] HTML de la fila (primeros 300 chars):', firstRow.innerHTML.substring(0, 300));
                
                // Mostrar la fila completa
                $firstRow.css({
                    'display': 'table-row',
                    'visibility': 'visible'
                });
                console.log('üü¢ [DEBUG] Estilos aplicados a la fila (display: table-row)');
                
                // Mostrar todas las celdas
                const $cells = $firstRow.find('td');
                console.log('üü° [DEBUG] Celdas encontradas en la fila:', $cells.length);
                $cells.each(function(index) {
                    console.log(`üü° [DEBUG] Celda ${index}:`, {
                        'tagName': this.tagName,
                        'className': this.className,
                        'innerHTML': this.innerHTML.substring(0, 100)
                    });
                });
                $cells.css({
                    'display': 'table-cell',
                    'visibility': 'visible'
                });
                console.log('üü¢ [DEBUG] Estilos aplicados a todas las celdas');
                
                // Esperar un momento para que el DOM se actualice
                setTimeout(function() {
                    console.log('üü° [DEBUG] Buscando select de producto...');
                    // Buscar el select de producto - probar m√∫ltiples selectores
                    let $productoSelect = $firstRow.find('select.nuevo-producto-select');
                    console.log('üü° [DEBUG] Select con clase nuevo-producto-select:', $productoSelect.length);
                    
                    if ($productoSelect.length === 0) {
                        $productoSelect = $firstRow.find('select[name$="-producto"]');
                        console.log('üü° [DEBUG] Select con name que termina en -producto:', $productoSelect.length);
                    }
                    if ($productoSelect.length === 0) {
                        $productoSelect = $firstRow.find('td.producto-cell select');
                        console.log('üü° [DEBUG] Select en td.producto-cell:', $productoSelect.length);
                    }
                    if ($productoSelect.length === 0) {
                        $productoSelect = $firstRow.find('select');
                        console.log('üü° [DEBUG] Cualquier select en la fila:', $productoSelect.length);
                    }
                    
                    console.log('üü¢ [DEBUG] Select encontrado:', $productoSelect.length);
                    
                    if ($productoSelect.length > 0) {
                        console.log('üü¢ [DEBUG] Detalles del select encontrado:', {
                            'id': $productoSelect.attr('id'),
                            'name': $productoSelect.attr('name'),
                            'class': $productoSelect.attr('class'),
                            'options': $productoSelect.find('option').length,
                            'currentValue': $productoSelect.val(),
                            'isVisible': $productoSelect.is(':visible'),
                            'computedDisplay': $productoSelect.css('display'),
                            'computedVisibility': $productoSelect.css('visibility'),
                            'parent': $productoSelect.parent().prop('tagName'),
                            'parentClass': $productoSelect.parent().attr('class')
                        });
                        
                        // Asegurar que el select y su contenedor sean visibles
                        console.log('üü¢ [DEBUG] Aplicando estilos al select...');
                        $productoSelect.css({
                            'display': 'block',
                            'visibility': 'visible',
                            'opacity': '1',
                            'width': '100%',
                            'min-width': '200px'
                        });
                        console.log('üü¢ [DEBUG] Estilos aplicados al select');
                        
                        const $productoCell = $productoSelect.closest('td.producto-cell');
                        console.log('üü° [DEBUG] Celda producto-cell encontrada:', $productoCell.length);
                        if ($productoCell.length) {
                            $productoCell.css({
                                'display': 'table-cell',
                                'visibility': 'visible',
                                'width': 'auto',
                                'min-width': '250px'
                            });
                            console.log('üü¢ [DEBUG] Estilos aplicados a la celda producto-cell');
                        } else {
                            console.warn('‚ö†Ô∏è [DEBUG] No se encontr√≥ td.producto-cell, buscando cualquier td...');
                            const $anyCell = $productoSelect.closest('td');
                            console.log('üü° [DEBUG] Cualquier celda encontrada:', $anyCell.length);
                            if ($anyCell.length) {
                                $anyCell.css({
                                    'display': 'table-cell',
                                    'visibility': 'visible'
                                });
                                console.log('üü¢ [DEBUG] Estilos aplicados a cualquier celda');
                            }
                        }
                        
                        // Verificar si jQuery y Select2 est√°n disponibles
                        console.log('üü° [DEBUG] jQuery disponible:', typeof $ !== 'undefined');
                        console.log('üü° [DEBUG] Select2 disponible:', typeof $ !== 'undefined' && $.fn.select2);
                        
                        // Inicializar Select2
                        if (typeof $ !== 'undefined' && $.fn.select2) {
                            console.log('üü¢ [DEBUG] Inicializando Select2...');
                            // Destruir si ya est√° inicializado
                            if ($productoSelect.hasClass('select2-hidden-accessible')) {
                                console.log('üü° [DEBUG] Select2 ya inicializado, destruyendo...');
                                $productoSelect.select2('destroy');
                            }
                            
                            // Inicializar Select2
                            try {
                                $productoSelect.select2({
                                    placeholder: 'Busca por CNIS o descripci√≥n',
                                    allowClear: true,
                                    width: '100%',
                                    language: 'es',
                                    dropdownParent: $('body')
                                });
                                console.log('üü¢ [DEBUG] Select2 inicializado correctamente');
                            } catch(e) {
                                console.error('‚ùå [DEBUG] Error al inicializar Select2:', e);
                                console.error('‚ùå [DEBUG] Stack:', e.stack);
                            }
                            
                            // Event listener para actualizar descripci√≥n
                            $productoSelect.off('change').on('change', function() {
                                console.log('üü¢ [DEBUG] Cambio detectado en select, valor:', $(this).val());
                                updateDescription(this);
                            });
                            
                            // Abrir el dropdown despu√©s de un delay
                            setTimeout(function() {
                                try {
                                    console.log('üü¢ [DEBUG] Intentando abrir Select2 dropdown...');
                                    $productoSelect.select2('open');
                                    console.log('üü¢ [DEBUG] Select2 dropdown abierto exitosamente');
                                } catch(e) {
                                    console.error('‚ùå [DEBUG] Error al abrir Select2:', e);
                                    console.error('‚ùå [DEBUG] Stack:', e.stack);
                                    // Si no se puede abrir, al menos enfocar el select
                                    $productoSelect.focus();
                                }
                            }, 400);
                        } else {
                            console.warn('‚ö†Ô∏è [DEBUG] jQuery o Select2 no est√°n disponibles');
                            console.warn('‚ö†Ô∏è [DEBUG] jQuery:', typeof $);
                            console.warn('‚ö†Ô∏è [DEBUG] Select2:', typeof $ !== 'undefined' ? (typeof $.fn.select2) : 'N/A');
                            // Al menos hacer el select visible
                            $productoSelect.css('display', 'block');
                        }
                        
                        // Verificar visibilidad final
                        setTimeout(function() {
                            const isVisible = $productoSelect.is(':visible');
                            const computedDisplay = $productoSelect.css('display');
                            const computedVisibility = $productoSelect.css('visibility');
                            const hasSelect2 = $productoSelect.hasClass('select2-hidden-accessible');
                            console.log('üü¢ [DEBUG] ========================================');
                            console.log('üü¢ [DEBUG] Estado final del select:');
                            console.log('üü¢ [DEBUG]   - isVisible:', isVisible);
                            console.log('üü¢ [DEBUG]   - computedDisplay:', computedDisplay);
                            console.log('üü¢ [DEBUG]   - computedVisibility:', computedVisibility);
                            console.log('üü¢ [DEBUG]   - hasSelect2:', hasSelect2);
                            console.log('üü¢ [DEBUG]   - select HTML (primeros 200 chars):', $productoSelect[0].outerHTML.substring(0, 200));
                            console.log('üü¢ [DEBUG] ========================================');
                        }, 500);
                    } else {
                        console.error('‚ùå [DEBUG] ========================================');
                        console.error('‚ùå [DEBUG] Select de producto NO encontrado en la fila');
                        console.error('‚ùå [DEBUG] ========================================');
                        console.error('‚ùå [DEBUG] Contenido completo de la fila (primeros 800 chars):');
                        console.log($firstRow[0].outerHTML.substring(0, 800));
                        console.error('‚ùå [DEBUG] Todos los elementos en la fila:');
                        $firstRow.find('*').each(function(index) {
                            if (index < 30) { // Limitar a los primeros 30 elementos
                                console.log(`  [${index}] ${this.tagName} - class: "${this.className || 'sin clase'}" - id: "${this.id || 'sin id'}"`);
                            }
                        });
                        console.error('‚ùå [DEBUG] Todos los selects en el documento:');
                        $('select').each(function(index) {
                            if (index < 10) {
                                console.log(`  [${index}] name: "${$(this).attr('name')}" - id: "${$(this).attr('id')}" - visible: ${$(this).is(':visible')}`);
                            }
                        });
                        alert('Error: No se encontr√≥ el campo de selecci√≥n de producto. Por favor, recarga la p√°gina y revisa la consola (F12) para m√°s detalles.');
                    }
                }, 200);
            } else {
                console.warn('‚ö†Ô∏è [DEBUG] ========================================');
                console.warn('‚ö†Ô∏è [DEBUG] No se encontraron filas ocultas');
                console.warn('‚ö†Ô∏è [DEBUG] ========================================');
                console.warn('‚ö†Ô∏è [DEBUG] Total filas nuevas:', allNewRows.length);
                allNewRows.forEach(function(row, index) {
                    const style = row.getAttribute('style') || '';
                    const computed = window.getComputedStyle(row);
                    const select = row.querySelector('select[name$="-producto"]');
                    console.warn(`‚ö†Ô∏è [DEBUG] Fila ${index}:`, {
                        'style': style,
                        'computedDisplay': computed.display,
                        'computedVisibility': computed.visibility,
                        'hasSelect': !!select,
                        'selectId': select ? select.id : 'N/A',
                        'selectName': select ? select.name : 'N/A',
                        'selectValue': select ? select.value : 'N/A',
                        'selectOptions': select ? select.options.length : 0
                    });
                });
                alert('Por favor, guarda los cambios para agregar m√°s items, o elimina un item para liberar espacio.');
            }
        });
    }
    
    // Botones para eliminar filas (items nuevos)
    document.querySelectorAll('.remove-row').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const row = this.closest('tr');
            const idField = row.querySelector('input[name$="-id"]');
            // Si es un item nuevo, ocultarlo y limpiar campos
            if (!idField || !idField.value) {
                row.style.display = 'none';
                // Limpiar campos
                row.querySelectorAll('input, select').forEach(function(field) {
                    if (field.type !== 'hidden' && field.name && !field.name.includes('DELETE')) {
                        if (field.tagName === 'SELECT') {
                            field.selectedIndex = 0;
                        } else {
                            field.value = '';
                        }
                    }
                });
            }
        });
    });
    
    // Manejar checkbox DELETE para ocultar/mostrar fila
    document.querySelectorAll('input[name$="-DELETE"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const row = this.closest('tr');
            if (this.checked) {
                row.style.opacity = '0.5';
            } else {
                row.style.opacity = '1';
            }
        });
    });
    
    // Inicializar Select2 para los campos de producto (items nuevos) que est√©n visibles
    function initializeVisibleSelects() {
        if (typeof $ !== 'undefined' && $.fn.select2) {
            $('tr.new-item-row:visible select[name$="-producto"]').each(function() {
                const $select = $(this);
                const $row = $select.closest('tr');
                const $idField = $row.find('input[name$="-id"]');
                // Solo inicializar Select2 para items nuevos que no est√©n ya inicializados
                if ((!$idField.length || !$idField.val()) && !$select.hasClass('select2-hidden-accessible')) {
                    $select.select2({
                        placeholder: 'Busca por CNIS o descripci√≥n',
                        allowClear: true,
                        width: '100%',
                        language: 'es',
                        dropdownParent: $select.closest('.table-responsive').length ? $select.closest('.table-responsive') : $('body')
                    });
                    
                    // Event listener para actualizar descripci√≥n
                    $select.on('change', function() {
                        updateDescription(this);
                    });
                }
            });
        }
    }
    
    // Inicializar selects visibles al cargar
    initializeVisibleSelects();
    
    // Re-inicializar cuando se muestre una fila nueva
    $(document).on('DOMNodeInserted', function() {
        initializeVisibleSelects();
    });

    // Aviso en tiempo real por folio de pedido duplicado
    var folioAvisoEl = document.getElementById('folio-pedido-aviso');
    var folioInput = document.getElementById('id_observaciones_solicitud');
    var folioCheckTimeout = null;
    var verificarFolioUrl = '{% url "logistica:verificar_folio_pedido" %}';
    var solicitudIdEditar = '{{ solicitud.id|escapejs }}';

    function mostrarAvisoFolio(existeActivo, existeCancelado) {
        if (!folioAvisoEl) return;
        if (existeActivo) {
            folioAvisoEl.className = 'mt-2 alert alert-danger';
            folioAvisoEl.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i> Ya existe un pedido <strong>activo</strong> con este folio. No puede duplicar. Use otro folio o cancele el pedido existente.';
            folioAvisoEl.style.display = 'block';
        } else if (existeCancelado) {
            folioAvisoEl.className = 'mt-2 alert alert-warning';
            folioAvisoEl.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i> Ya existe un pedido <strong>cancelado</strong> con este folio. Puede continuar si es correcto.';
            folioAvisoEl.style.display = 'block';
        } else {
            folioAvisoEl.style.display = 'none';
            folioAvisoEl.innerHTML = '';
        }
    }

    function verificarFolioPedido() {
        var valor = (folioInput && folioInput.value) ? folioInput.value.trim() : '';
        if (!valor) {
            folioAvisoEl.style.display = 'none';
            folioAvisoEl.innerHTML = '';
            return;
        }
        var url = verificarFolioUrl + '?folio=' + encodeURIComponent(valor) + '&solicitud_id=' + encodeURIComponent(solicitudIdEditar);
        fetch(url, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
            credentials: 'same-origin'
        }).then(function(r) { return r.json(); })
          .then(function(data) {
            mostrarAvisoFolio(data.existe_activo, data.existe_cancelado);
        }).catch(function() {
            folioAvisoEl.style.display = 'none';
        });
    }

    if (folioInput) {
        folioInput.addEventListener('blur', verificarFolioPedido);
        folioInput.addEventListener('input', function() {
            if (folioCheckTimeout) clearTimeout(folioCheckTimeout);
            var v = (folioInput.value || '').trim();
            if (!v) {
                folioAvisoEl.style.display = 'none';
                folioAvisoEl.innerHTML = '';
                return;
            }
            folioCheckTimeout = setTimeout(verificarFolioPedido, 500);
        });
    }
});
</script>
{% endblock %}
{% endblock %}
