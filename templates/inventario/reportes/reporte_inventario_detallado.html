{% extends 'base.html' %}
{% load static %}

{% block title %}Reporte de Inventario Detallado{% endblock %}

{% block extra_css %}
<style>
.sortable-header:hover { opacity: 0.9; text-decoration: underline !important; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fas fa-clipboard-list text-primary"></i> Reporte de Inventario Detallado</h2>
            <p class="text-muted">Visualiza el inventario con información completa de entidades, órdenes de suministro y lotes</p>
        </div>
        <div class="col-md-4 text-end d-flex align-items-end justify-content-end gap-2">
            <a href="{% url 'reportes:carga_masiva_inventario_detallado' %}" class="btn btn-outline-primary">
                <i class="fas fa-file-upload"></i> Carga masiva
            </a>
            {% if datos_reporte %}
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalExportarExcel">
                <i class="fas fa-file-excel"></i> Exportar a Excel
            </button>
            {% endif %}
        </div>
    </div>

    <!-- Filtros de Búsqueda -->
    <div class="card shadow mb-4">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-filter"></i> Filtros de Búsqueda</h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="entidad" class="form-label">Entidad</label>
                    <input type="text" class="form-control" id="entidad" name="entidad" 
                           value="{{ filtro_entidad }}" placeholder="Buscar por entidad...">
                </div>
                <div class="col-md-3">
                    <label for="clues" class="form-label">CLUES</label>
                    <input type="text" class="form-control" id="clues" name="clues" 
                           value="{{ filtro_clues }}" placeholder="Buscar por CLUES...">
                </div>
                <div class="col-md-3">
                    <label for="orden" class="form-label">Orden de Suministro</label>
                    <input type="text" class="form-control" id="orden" name="orden" 
                           value="{{ filtro_orden }}" placeholder="Buscar por orden...">
                </div>
                <div class="col-md-3">
                    <label for="rfc" class="form-label">RFC</label>
                    <input type="text" class="form-control" id="rfc" name="rfc" 
                           value="{{ filtro_rfc }}" placeholder="Buscar por RFC...">
                </div>
                <div class="col-md-3">
                    <label for="clave" class="form-label">Clave CNIS</label>
                    <input type="text" class="form-control" id="clave" name="clave" 
                           value="{{ filtro_clave }}" placeholder="Buscar por clave...">
                </div>
                <div class="col-md-3">
                    <label for="lote" class="form-label">Número de Lote</label>
                    <input type="text" class="form-control" id="lote" name="lote" 
                           value="{{ filtro_lote }}" placeholder="Buscar por lote...">
                </div>
                <div class="col-md-3">
                    <label for="estado" class="form-label">Estado del Insumo</label>
                    <select class="form-control" id="estado" name="estado">
                        <option value="">-- Todos los estados --</option>
                        {% for estado_val, estado_label in estados_lote %}
                            <option value="{{ estado_val }}" {% if filtro_estado == estado_val|stringformat:"s" %}selected{% endif %}>
                                {{ estado_label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="excluir_sin_orden" value="si" id="excluir_sin_orden" {% if excluir_sin_orden %}checked{% endif %}>
                        <label class="form-check-label" for="excluir_sin_orden">
                            Excluir sin orden de suministro
                        </label>
                    </div>
                </div>
                <div class="col-md-6 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                    <a href="{% url 'reportes:reporte_inventario_detallado' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo"></i> Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Resultados -->
    {% if datos_reporte %}
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
                <i class="fas fa-table"></i> Resultados 
                <span class="badge bg-light text-dark ms-2">{{ lotes_paginados.paginator.count }} registro(s)</span>
            </h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=entidad&order={% if sort_column == 'entidad' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    ENTIDAD {% if sort_column == 'entidad' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=clues&order={% if sort_column == 'clues' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    CLUES {% if sort_column == 'clues' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=orden&order={% if sort_column == 'orden' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    ORDEN DE SUMINISTRO {% if sort_column == 'orden' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=rfc&order={% if sort_column == 'rfc' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    RFC {% if sort_column == 'rfc' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=clave&order={% if sort_column == 'clave' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    CLAVE {% if sort_column == 'clave' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=descripcion&order={% if sort_column == 'descripcion' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    DESCRIPCIÓN {% if sort_column == 'descripcion' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=estado&order={% if sort_column == 'estado' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    ESTADO DEL INSUMO {% if sort_column == 'estado' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th class="text-end">
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=inventario&order={% if sort_column == 'inventario' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    INVENTARIO DISPONIBLE {% if sort_column == 'inventario' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=lote&order={% if sort_column == 'lote' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    LOTE {% if sort_column == 'lote' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=f_cad&order={% if sort_column == 'f_cad' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    F_CAD {% if sort_column == 'f_cad' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=f_fab&order={% if sort_column == 'f_fab' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    F_FAB {% if sort_column == 'f_fab' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="?{{ sort_base_query }}{% if sort_base_query %}&{% endif %}sort=f_rec&order={% if sort_column == 'f_rec' and sort_order == 'asc' %}desc{% else %}asc{% endif %}" class="text-white text-decoration-none sortable-header">
                                    F_REC {% if sort_column == 'f_rec' %}<i class="fas fa-caret-{% if sort_order == 'asc' %}up{% else %}down{% endif %} ms-1"></i>{% endif %}
                                </a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dato in datos_reporte %}
                        <tr>
                            <td>{{ dato.entidad }}</td>
                            <td>{{ dato.clues }}</td>
                            <td>{{ dato.orden_suministro }}</td>
                            <td>{{ dato.rfc }}</td>
                            <td>{{ dato.clave }}</td>
                            <td><small>{{ dato.descripcion|truncatewords:15 }}</small></td>
                            <td>
                                {% if dato.estado_insumo == 'Disponible' %}
                                    <span class="badge bg-success">{{ dato.estado_insumo }}</span>
                                {% elif dato.estado_insumo == 'Suspendido' %}
                                    <span class="badge bg-warning">{{ dato.estado_insumo }}</span>
                                {% elif dato.estado_insumo == 'Deteriorado' %}
                                    <span class="badge bg-danger">{{ dato.estado_insumo }}</span>
                                {% elif dato.estado_insumo == 'Caducado' %}
                                    <span class="badge bg-dark">{{ dato.estado_insumo }}</span>
                                {% else %}
                                    {{ dato.estado_insumo }}
                                {% endif %}
                            </td>
                            <td class="text-end">{{ dato.inventario_disponible|floatformat:0 }}</td>
                            <td>{{ dato.lote }}</td>
                            <td>{{ dato.f_cad }}</td>
                            <td>{{ dato.f_fab }}</td>
                            <td>{{ dato.f_rec }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                No se encontraron registros con los filtros aplicados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Paginación -->
        {% if lotes_paginados.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Paginación">
                <ul class="pagination justify-content-center mb-0">
                    {% if lotes_paginados.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1{% if request.GET.entidad %}&entidad={{ request.GET.entidad }}{% endif %}{% if request.GET.clues %}&clues={{ request.GET.clues }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}{% if request.GET.rfc %}&rfc={{ request.GET.rfc }}{% endif %}{% if request.GET.clave %}&clave={{ request.GET.clave }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.lote %}&lote={{ request.GET.lote }}{% endif %}{% if request.GET.excluir_sin_orden %}&excluir_sin_orden={{ request.GET.excluir_sin_orden }}{% endif %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ lotes_paginados.previous_page_number }}{% if request.GET.entidad %}&entidad={{ request.GET.entidad }}{% endif %}{% if request.GET.clues %}&clues={{ request.GET.clues }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}{% if request.GET.rfc %}&rfc={{ request.GET.rfc }}{% endif %}{% if request.GET.clave %}&clave={{ request.GET.clave }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.lote %}&lote={{ request.GET.lote }}{% endif %}{% if request.GET.excluir_sin_orden %}&excluir_sin_orden={{ request.GET.excluir_sin_orden }}{% endif %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            Página {{ lotes_paginados.number }} de {{ lotes_paginados.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if lotes_paginados.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ lotes_paginados.next_page_number }}{% if request.GET.entidad %}&entidad={{ request.GET.entidad }}{% endif %}{% if request.GET.clues %}&clues={{ request.GET.clues }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}{% if request.GET.rfc %}&rfc={{ request.GET.rfc }}{% endif %}{% if request.GET.clave %}&clave={{ request.GET.clave }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.lote %}&lote={{ request.GET.lote }}{% endif %}{% if request.GET.excluir_sin_orden %}&excluir_sin_orden={{ request.GET.excluir_sin_orden }}{% endif %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ lotes_paginados.paginator.num_pages }}{% if request.GET.entidad %}&entidad={{ request.GET.entidad }}{% endif %}{% if request.GET.clues %}&clues={{ request.GET.clues }}{% endif %}{% if request.GET.orden %}&orden={{ request.GET.orden }}{% endif %}{% if request.GET.rfc %}&rfc={{ request.GET.rfc }}{% endif %}{% if request.GET.clave %}&clave={{ request.GET.clave }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.lote %}&lote={{ request.GET.lote }}{% endif %}{% if request.GET.excluir_sin_orden %}&excluir_sin_orden={{ request.GET.excluir_sin_orden }}{% endif %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> Utiliza los filtros para buscar registros de inventario.
    </div>
    {% endif %}
</div>

<!-- Modal: Seleccionar columnas para exportar a Excel -->
{% if datos_reporte and columnas_disponibles %}
<div class="modal fade" id="modalExportarExcel" tabindex="-1" aria-labelledby="modalExportarExcelLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="modalExportarExcelLabel">Exportar a Excel – elegir columnas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form method="post" action="{% url 'reportes:exportar_inventario_detallado_excel' %}" id="formExportarExcel">
                {% csrf_token %}
                <div class="modal-body">
                    <p class="text-muted small">Selecciona las columnas a exportar y arrastra para cambiar el orden.</p>
                    <ul id="lista-columnas-export" class="list-group">
                        {% for col in columnas_disponibles %}
                        <li class="list-group-item d-flex justify-content-between align-items-center draggable-item">
                            <div>
                                <input type="checkbox" name="columnas" value="{{ col.value }}" id="col_export_{{ col.value }}" class="form-check-input me-2">
                                <label for="col_export_{{ col.value }}" class="mb-0">{{ col.label }}</label>
                            </div>
                            <span class="handle text-secondary" style="cursor: grab;">☰</span>
                        </li>
                        {% endfor %}
                    </ul>
                    <input type="hidden" name="orden_columnas" id="orden_columnas_export">
                    <input type="hidden" name="entidad" value="{{ filtro_entidad }}">
                    <input type="hidden" name="clues" value="{{ filtro_clues }}">
                    <input type="hidden" name="orden" value="{{ filtro_orden }}">
                    <input type="hidden" name="rfc" value="{{ filtro_rfc }}">
                    <input type="hidden" name="clave" value="{{ filtro_clave }}">
                    <input type="hidden" name="estado" value="{{ filtro_estado }}">
                    <input type="hidden" name="lote" value="{{ filtro_lote }}">
                    <input type="hidden" name="excluir_sin_orden" value="{% if excluir_sin_orden %}si{% endif %}">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btnExportarExcel">
                        <i class="fas fa-file-excel"></i> Generar Excel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
(function() {
    var list = document.getElementById('lista-columnas-export');
    if (!list) return;
    var checkboxes = list.querySelectorAll('input[name="columnas"]');
    checkboxes.forEach(function(cb) { cb.checked = true; });

    var sortable = new Sortable(list, {
        handle: '.handle',
        animation: 150,
        onEnd: function() {
            var order = [];
            list.querySelectorAll('input[name="columnas"]').forEach(function(cb) {
                if (cb.checked) order.push(cb.value);
            });
            document.getElementById('orden_columnas_export').value = order.join(',');
        }
    });

    document.getElementById('formExportarExcel').addEventListener('submit', function() {
        var order = [];
        list.querySelectorAll('li').forEach(function(li) {
            var cb = li.querySelector('input[name="columnas"]');
            if (cb && cb.checked) order.push(cb.value);
        });
        document.getElementById('orden_columnas_export').value = order.join(',');
    });
})();
</script>
{% endblock %}
